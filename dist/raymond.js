!function(t,e){"function"==typeof define&&define.amd?define([],e):t.Raymond=e()}(this,function(){var t,e,n;!function(r){function i(t,e){return x.call(t,e)}function a(t,e){var n,r,i,a,o,s,u,c,b,l,f,h=e&&e.split("/"),d=g.map,m=d&&d["*"]||{};if(t&&"."===t.charAt(0))if(e){for(t=t.split("/"),o=t.length-1,g.nodeIdCompat&&w.test(t[o])&&(t[o]=t[o].replace(w,"")),t=h.slice(0,h.length-1).concat(t),b=0;b<t.length;b+=1)if(f=t[b],"."===f)t.splice(b,1),b-=1;else if(".."===f){if(1===b&&(".."===t[2]||".."===t[0]))break;b>0&&(t.splice(b-1,2),b-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((h||m)&&d){for(n=t.split("/"),b=n.length;b>0;b-=1){if(r=n.slice(0,b).join("/"),h)for(l=h.length;l>0;l-=1)if(i=d[h.slice(0,l).join("/")],i&&(i=i[r])){a=i,s=b;break}if(a)break;!u&&m&&m[r]&&(u=m[r],c=b)}!a&&u&&(a=u,s=c),a&&(n.splice(0,s,a),t=n.join("/"))}return t}function o(t,e){return function(){var n=y.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),h.apply(r,n.concat([t,e]))}}function s(t){return function(e){return a(e,t)}}function u(t){return function(e){p[t]=e}}function c(t){if(i(v,t)){var e=v[t];delete v[t],M[t]=!0,f.apply(r,e)}if(!i(p,t)&&!i(M,t))throw new Error("No "+t);return p[t]}function b(t){var e,n=t?t.indexOf("!"):-1;return n>-1&&(e=t.substring(0,n),t=t.substring(n+1,t.length)),[e,t]}function l(t){return function(){return g&&g.config&&g.config[t]||{}}}var f,h,d,m,p={},v={},g={},M={},x=Object.prototype.hasOwnProperty,y=[].slice,w=/\.js$/;d=function(t,e){var n,r=b(t),i=r[0];return t=r[1],i&&(i=a(i,e),n=c(i)),i?t=n&&n.normalize?n.normalize(t,s(e)):a(t,e):(t=a(t,e),r=b(t),i=r[0],t=r[1],i&&(n=c(i))),{f:i?i+"!"+t:t,n:t,pr:i,p:n}},m={require:function(t){return o(t)},exports:function(t){var e=p[t];return"undefined"!=typeof e?e:p[t]={}},module:function(t){return{id:t,uri:"",exports:p[t],config:l(t)}}},f=function(t,e,n,a){var s,b,l,f,h,g,x=[],y=typeof n;if(a=a||t,"undefined"===y||"function"===y){for(e=!e.length&&n.length?["require","exports","module"]:e,h=0;h<e.length;h+=1)if(f=d(e[h],a),b=f.f,"require"===b)x[h]=m.require(t);else if("exports"===b)x[h]=m.exports(t),g=!0;else if("module"===b)s=x[h]=m.module(t);else if(i(p,b)||i(v,b)||i(M,b))x[h]=c(b);else{if(!f.p)throw new Error(t+" missing "+b);f.p.load(f.n,o(a,!0),u(b),{}),x[h]=p[b]}l=n?n.apply(p[t],x):void 0,t&&(s&&s.exports!==r&&s.exports!==p[t]?p[t]=s.exports:l===r&&g||(p[t]=l))}else t&&(p[t]=n)},t=e=h=function(t,e,n,i,a){if("string"==typeof t)return m[t]?m[t](e):c(d(t,e).f);if(!t.splice){if(g=t,g.deps&&h(g.deps,g.callback),!e)return;e.splice?(t=e,e=n,n=null):t=r}return e=e||function(){},"function"==typeof n&&(n=i,i=a),i?f(r,t,e,n):setTimeout(function(){f(r,t,e,n)},4),h},h.config=function(t){return h(t)},t._defined=p,n=function(t,e,n){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");e.splice||(n=e,e=[]),i(p,t)||i(v,t)||(v[t]=[t,e,n])},n.amd={jQuery:!0}}(),n("../bower_components/almond/almond",function(){}),function(t){"use strict";var e={};"undefined"==typeof exports?"function"==typeof n&&"object"==typeof n.amd&&n.amd?(e.exports={},n("gl-matrix",[],function(){return e.exports})):e.exports="undefined"!=typeof window?window:t:e.exports=exports,function(t){if(!e)var e=1e-6;if(!n)var n="undefined"!=typeof Float32Array?Float32Array:Array;if(!r)var r=Math.random;var i={};i.setMatrixArrayType=function(t){n=t},"undefined"!=typeof t&&(t.glMatrix=i);var a=Math.PI/180;i.toRadian=function(t){return t*a};var o={};o.create=function(){var t=new n(2);return t[0]=0,t[1]=0,t},o.clone=function(t){var e=new n(2);return e[0]=t[0],e[1]=t[1],e},o.fromValues=function(t,e){var r=new n(2);return r[0]=t,r[1]=e,r},o.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t},o.set=function(t,e,n){return t[0]=e,t[1]=n,t},o.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t},o.subtract=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t},o.sub=o.subtract,o.multiply=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t},o.mul=o.multiply,o.divide=function(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t},o.div=o.divide,o.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t},o.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t},o.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t},o.scaleAndAdd=function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t},o.distance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(n*n+r*r)},o.dist=o.distance,o.squaredDistance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},o.sqrDist=o.squaredDistance,o.length=function(t){var e=t[0],n=t[1];return Math.sqrt(e*e+n*n)},o.len=o.length,o.squaredLength=function(t){var e=t[0],n=t[1];return e*e+n*n},o.sqrLen=o.squaredLength,o.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},o.normalize=function(t,e){var n=e[0],r=e[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i),t},o.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},o.cross=function(t,e,n){var r=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=r,t},o.lerp=function(t,e,n,r){var i=e[0],a=e[1];return t[0]=i+r*(n[0]-i),t[1]=a+r*(n[1]-a),t},o.random=function(t,e){e=e||1;var n=2*r()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t},o.transformMat2=function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i,t[1]=n[1]*r+n[3]*i,t},o.transformMat2d=function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i+n[4],t[1]=n[1]*r+n[3]*i+n[5],t},o.transformMat3=function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[3]*i+n[6],t[1]=n[1]*r+n[4]*i+n[7],t},o.transformMat4=function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[4]*i+n[12],t[1]=n[1]*r+n[5]*i+n[13],t},o.forEach=function(){var t=o.create();return function(e,n,r,i,a,o){var s,u;for(n||(n=2),r||(r=0),u=i?Math.min(i*n+r,e.length):e.length,s=r;u>s;s+=n)t[0]=e[s],t[1]=e[s+1],a(t,t,o),e[s]=t[0],e[s+1]=t[1];return e}}(),o.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},"undefined"!=typeof t&&(t.vec2=o);var s={};s.create=function(){var t=new n(3);return t[0]=0,t[1]=0,t[2]=0,t},s.clone=function(t){var e=new n(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},s.fromValues=function(t,e,r){var i=new n(3);return i[0]=t,i[1]=e,i[2]=r,i},s.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},s.set=function(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t},s.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t},s.subtract=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t},s.sub=s.subtract,s.multiply=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t},s.mul=s.multiply,s.divide=function(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t},s.div=s.divide,s.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},s.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},s.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},s.scaleAndAdd=function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t},s.distance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)},s.dist=s.distance,s.squaredDistance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i},s.sqrDist=s.squaredDistance,s.length=function(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)},s.len=s.length,s.squaredLength=function(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r},s.sqrLen=s.squaredLength,s.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},s.normalize=function(t,e){var n=e[0],r=e[1],i=e[2],a=n*n+r*r+i*i;return a>0&&(a=1/Math.sqrt(a),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a),t},s.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},s.cross=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=n[0],s=n[1],u=n[2];return t[0]=i*u-a*s,t[1]=a*o-r*u,t[2]=r*s-i*o,t},s.lerp=function(t,e,n,r){var i=e[0],a=e[1],o=e[2];return t[0]=i+r*(n[0]-i),t[1]=a+r*(n[1]-a),t[2]=o+r*(n[2]-o),t},s.random=function(t,e){e=e||1;var n=2*r()*Math.PI,i=2*r()-1,a=Math.sqrt(1-i*i)*e;return t[0]=Math.cos(n)*a,t[1]=Math.sin(n)*a,t[2]=i*e,t},s.transformMat4=function(t,e,n){var r=e[0],i=e[1],a=e[2];return t[0]=n[0]*r+n[4]*i+n[8]*a+n[12],t[1]=n[1]*r+n[5]*i+n[9]*a+n[13],t[2]=n[2]*r+n[6]*i+n[10]*a+n[14],t},s.transformMat3=function(t,e,n){var r=e[0],i=e[1],a=e[2];return t[0]=r*n[0]+i*n[3]+a*n[6],t[1]=r*n[1]+i*n[4]+a*n[7],t[2]=r*n[2]+i*n[5]+a*n[8],t},s.transformQuat=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=n[0],s=n[1],u=n[2],c=n[3],b=c*r+s*a-u*i,l=c*i+u*r-o*a,f=c*a+o*i-s*r,h=-o*r-s*i-u*a;return t[0]=b*c+h*-o+l*-u-f*-s,t[1]=l*c+h*-s+f*-o-b*-u,t[2]=f*c+h*-u+b*-s-l*-o,t},s.rotateX=function(t,e,n,r){var i=[],a=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=a[0]+n[0],t[1]=a[1]+n[1],t[2]=a[2]+n[2],t},s.rotateY=function(t,e,n,r){var i=[],a=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=a[0]+n[0],t[1]=a[1]+n[1],t[2]=a[2]+n[2],t},s.rotateZ=function(t,e,n,r){var i=[],a=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],t[0]=a[0]+n[0],t[1]=a[1]+n[1],t[2]=a[2]+n[2],t},s.forEach=function(){var t=s.create();return function(e,n,r,i,a,o){var s,u;for(n||(n=3),r||(r=0),u=i?Math.min(i*n+r,e.length):e.length,s=r;u>s;s+=n)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],a(t,t,o),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2];return e}}(),s.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},"undefined"!=typeof t&&(t.vec3=s);var u={};u.create=function(){var t=new n(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},u.clone=function(t){var e=new n(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},u.fromValues=function(t,e,r,i){var a=new n(4);return a[0]=t,a[1]=e,a[2]=r,a[3]=i,a},u.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},u.set=function(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t},u.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t},u.subtract=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t},u.sub=u.subtract,u.multiply=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t},u.mul=u.multiply,u.divide=function(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t},u.div=u.divide,u.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t},u.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t},u.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},u.scaleAndAdd=function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t},u.distance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return Math.sqrt(n*n+r*r+i*i+a*a)},u.dist=u.distance,u.squaredDistance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return n*n+r*r+i*i+a*a},u.sqrDist=u.squaredDistance,u.length=function(t){var e=t[0],n=t[1],r=t[2],i=t[3];return Math.sqrt(e*e+n*n+r*r+i*i)},u.len=u.length,u.squaredLength=function(t){var e=t[0],n=t[1],r=t[2],i=t[3];return e*e+n*n+r*r+i*i},u.sqrLen=u.squaredLength,u.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},u.normalize=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n*n+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t[3]=e[3]*o),t},u.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},u.lerp=function(t,e,n,r){var i=e[0],a=e[1],o=e[2],s=e[3];return t[0]=i+r*(n[0]-i),t[1]=a+r*(n[1]-a),t[2]=o+r*(n[2]-o),t[3]=s+r*(n[3]-s),t},u.random=function(t,e){return e=e||1,t[0]=r(),t[1]=r(),t[2]=r(),t[3]=r(),u.normalize(t,t),u.scale(t,t,e),t},u.transformMat4=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*a+n[12]*o,t[1]=n[1]*r+n[5]*i+n[9]*a+n[13]*o,t[2]=n[2]*r+n[6]*i+n[10]*a+n[14]*o,t[3]=n[3]*r+n[7]*i+n[11]*a+n[15]*o,t},u.transformQuat=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=n[0],s=n[1],u=n[2],c=n[3],b=c*r+s*a-u*i,l=c*i+u*r-o*a,f=c*a+o*i-s*r,h=-o*r-s*i-u*a;return t[0]=b*c+h*-o+l*-u-f*-s,t[1]=l*c+h*-s+f*-o-b*-u,t[2]=f*c+h*-u+b*-s-l*-o,t},u.forEach=function(){var t=u.create();return function(e,n,r,i,a,o){var s,u;for(n||(n=4),r||(r=0),u=i?Math.min(i*n+r,e.length):e.length,s=r;u>s;s+=n)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],a(t,t,o),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),u.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},"undefined"!=typeof t&&(t.vec4=u);var c={};c.create=function(){var t=new n(4);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},c.clone=function(t){var e=new n(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},c.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},c.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},c.transpose=function(t,e){if(t===e){var n=e[1];t[1]=e[2],t[2]=n}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},c.invert=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n*a-i*r;return o?(o=1/o,t[0]=a*o,t[1]=-r*o,t[2]=-i*o,t[3]=n*o,t):null},c.adjoint=function(t,e){var n=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=n,t},c.determinant=function(t){return t[0]*t[3]-t[2]*t[1]},c.multiply=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=n[0],u=n[1],c=n[2],b=n[3];return t[0]=r*s+a*u,t[1]=i*s+o*u,t[2]=r*c+a*b,t[3]=i*c+o*b,t},c.mul=c.multiply,c.rotate=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(n),u=Math.cos(n);return t[0]=r*u+a*s,t[1]=i*u+o*s,t[2]=r*-s+a*u,t[3]=i*-s+o*u,t},c.scale=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=n[0],u=n[1];return t[0]=r*s,t[1]=i*s,t[2]=a*u,t[3]=o*u,t},c.str=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},c.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},c.LDU=function(t,e,n,r){return t[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-t[2]*n[1],[t,e,n]},"undefined"!=typeof t&&(t.mat2=c);var b={};b.create=function(){var t=new n(6);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},b.clone=function(t){var e=new n(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},b.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},b.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},b.invert=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=n*a-r*i;return u?(u=1/u,t[0]=a*u,t[1]=-r*u,t[2]=-i*u,t[3]=n*u,t[4]=(i*s-a*o)*u,t[5]=(r*o-n*s)*u,t):null},b.determinant=function(t){return t[0]*t[3]-t[1]*t[2]},b.multiply=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=n[0],b=n[1],l=n[2],f=n[3],h=n[4],d=n[5];return t[0]=r*c+a*b,t[1]=i*c+o*b,t[2]=r*l+a*f,t[3]=i*l+o*f,t[4]=r*h+a*d+s,t[5]=i*h+o*d+u,t},b.mul=b.multiply,b.rotate=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=Math.sin(n),b=Math.cos(n);return t[0]=r*b+a*c,t[1]=i*b+o*c,t[2]=r*-c+a*b,t[3]=i*-c+o*b,t[4]=s,t[5]=u,t},b.scale=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=n[0],b=n[1];return t[0]=r*c,t[1]=i*c,t[2]=a*b,t[3]=o*b,t[4]=s,t[5]=u,t},b.translate=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=n[0],b=n[1];return t[0]=r,t[1]=i,t[2]=a,t[3]=o,t[4]=r*c+a*b+s,t[5]=i*c+o*b+u,t},b.str=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},b.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},"undefined"!=typeof t&&(t.mat2d=b);var l={};l.create=function(){var t=new n(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},l.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},l.clone=function(t){var e=new n(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},l.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},l.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},l.transpose=function(t,e){if(t===e){var n=e[1],r=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},l.invert=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],c=e[7],b=e[8],l=b*o-s*c,f=-b*a+s*u,h=c*a-o*u,d=n*l+r*f+i*h;return d?(d=1/d,t[0]=l*d,t[1]=(-b*r+i*c)*d,t[2]=(s*r-i*o)*d,t[3]=f*d,t[4]=(b*n-i*u)*d,t[5]=(-s*n+i*a)*d,t[6]=h*d,t[7]=(-c*n+r*u)*d,t[8]=(o*n-r*a)*d,t):null},l.adjoint=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],c=e[7],b=e[8];return t[0]=o*b-s*c,t[1]=i*c-r*b,t[2]=r*s-i*o,t[3]=s*u-a*b,t[4]=n*b-i*u,t[5]=i*a-n*s,t[6]=a*c-o*u,t[7]=r*u-n*c,t[8]=n*o-r*a,t},l.determinant=function(t){var e=t[0],n=t[1],r=t[2],i=t[3],a=t[4],o=t[5],s=t[6],u=t[7],c=t[8];return e*(c*a-o*u)+n*(-c*i+o*s)+r*(u*i-a*s)},l.multiply=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=e[6],b=e[7],l=e[8],f=n[0],h=n[1],d=n[2],m=n[3],p=n[4],v=n[5],g=n[6],M=n[7],x=n[8];return t[0]=f*r+h*o+d*c,t[1]=f*i+h*s+d*b,t[2]=f*a+h*u+d*l,t[3]=m*r+p*o+v*c,t[4]=m*i+p*s+v*b,t[5]=m*a+p*u+v*l,t[6]=g*r+M*o+x*c,t[7]=g*i+M*s+x*b,t[8]=g*a+M*u+x*l,t},l.mul=l.multiply,l.translate=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=e[6],b=e[7],l=e[8],f=n[0],h=n[1];return t[0]=r,t[1]=i,t[2]=a,t[3]=o,t[4]=s,t[5]=u,t[6]=f*r+h*o+c,t[7]=f*i+h*s+b,t[8]=f*a+h*u+l,t},l.rotate=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=e[6],b=e[7],l=e[8],f=Math.sin(n),h=Math.cos(n);return t[0]=h*r+f*o,t[1]=h*i+f*s,t[2]=h*a+f*u,t[3]=h*o-f*r,t[4]=h*s-f*i,t[5]=h*u-f*a,t[6]=c,t[7]=b,t[8]=l,t},l.scale=function(t,e,n){var r=n[0],i=n[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},l.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},l.fromQuat=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n+n,s=r+r,u=i+i,c=n*o,b=r*o,l=r*s,f=i*o,h=i*s,d=i*u,m=a*o,p=a*s,v=a*u;return t[0]=1-l-d,t[3]=b-v,t[6]=f+p,t[1]=b+v,t[4]=1-c-d,t[7]=h-m,t[2]=f-p,t[5]=h+m,t[8]=1-c-l,t},l.normalFromMat4=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],c=e[7],b=e[8],l=e[9],f=e[10],h=e[11],d=e[12],m=e[13],p=e[14],v=e[15],g=n*s-r*o,M=n*u-i*o,x=n*c-a*o,y=r*u-i*s,w=r*c-a*s,T=i*c-a*u,E=b*m-l*d,S=b*p-f*d,R=b*v-h*d,_=l*p-f*m,L=l*v-h*m,A=f*v-h*p,P=g*A-M*L+x*_+y*R-w*S+T*E;return P?(P=1/P,t[0]=(s*A-u*L+c*_)*P,t[1]=(u*R-o*A-c*S)*P,t[2]=(o*L-s*R+c*E)*P,t[3]=(i*L-r*A-a*_)*P,t[4]=(n*A-i*R+a*S)*P,t[5]=(r*R-n*L-a*E)*P,t[6]=(m*T-p*w+v*y)*P,t[7]=(p*x-d*T-v*M)*P,t[8]=(d*w-m*x+v*g)*P,t):null},l.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},l.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},"undefined"!=typeof t&&(t.mat3=l);var f={};f.create=function(){var t=new n(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},f.clone=function(t){var e=new n(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},f.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},f.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},f.transpose=function(t,e){if(t===e){var n=e[1],r=e[2],i=e[3],a=e[6],o=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=a,t[11]=e[14],t[12]=i,t[13]=o,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},f.invert=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],c=e[7],b=e[8],l=e[9],f=e[10],h=e[11],d=e[12],m=e[13],p=e[14],v=e[15],g=n*s-r*o,M=n*u-i*o,x=n*c-a*o,y=r*u-i*s,w=r*c-a*s,T=i*c-a*u,E=b*m-l*d,S=b*p-f*d,R=b*v-h*d,_=l*p-f*m,L=l*v-h*m,A=f*v-h*p,P=g*A-M*L+x*_+y*R-w*S+T*E;return P?(P=1/P,t[0]=(s*A-u*L+c*_)*P,t[1]=(i*L-r*A-a*_)*P,t[2]=(m*T-p*w+v*y)*P,t[3]=(f*w-l*T-h*y)*P,t[4]=(u*R-o*A-c*S)*P,t[5]=(n*A-i*R+a*S)*P,t[6]=(p*x-d*T-v*M)*P,t[7]=(b*T-f*x+h*M)*P,t[8]=(o*L-s*R+c*E)*P,t[9]=(r*R-n*L-a*E)*P,t[10]=(d*w-m*x+v*g)*P,t[11]=(l*x-b*w-h*g)*P,t[12]=(s*S-o*_-u*E)*P,t[13]=(n*_-r*S+i*E)*P,t[14]=(m*M-d*y-p*g)*P,t[15]=(b*y-l*M+f*g)*P,t):null},f.adjoint=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=e[4],s=e[5],u=e[6],c=e[7],b=e[8],l=e[9],f=e[10],h=e[11],d=e[12],m=e[13],p=e[14],v=e[15];return t[0]=s*(f*v-h*p)-l*(u*v-c*p)+m*(u*h-c*f),t[1]=-(r*(f*v-h*p)-l*(i*v-a*p)+m*(i*h-a*f)),t[2]=r*(u*v-c*p)-s*(i*v-a*p)+m*(i*c-a*u),t[3]=-(r*(u*h-c*f)-s*(i*h-a*f)+l*(i*c-a*u)),t[4]=-(o*(f*v-h*p)-b*(u*v-c*p)+d*(u*h-c*f)),t[5]=n*(f*v-h*p)-b*(i*v-a*p)+d*(i*h-a*f),t[6]=-(n*(u*v-c*p)-o*(i*v-a*p)+d*(i*c-a*u)),t[7]=n*(u*h-c*f)-o*(i*h-a*f)+b*(i*c-a*u),t[8]=o*(l*v-h*m)-b*(s*v-c*m)+d*(s*h-c*l),t[9]=-(n*(l*v-h*m)-b*(r*v-a*m)+d*(r*h-a*l)),t[10]=n*(s*v-c*m)-o*(r*v-a*m)+d*(r*c-a*s),t[11]=-(n*(s*h-c*l)-o*(r*h-a*l)+b*(r*c-a*s)),t[12]=-(o*(l*p-f*m)-b*(s*p-u*m)+d*(s*f-u*l)),t[13]=n*(l*p-f*m)-b*(r*p-i*m)+d*(r*f-i*l),t[14]=-(n*(s*p-u*m)-o*(r*p-i*m)+d*(r*u-i*s)),t[15]=n*(s*f-u*l)-o*(r*f-i*l)+b*(r*u-i*s),t},f.determinant=function(t){var e=t[0],n=t[1],r=t[2],i=t[3],a=t[4],o=t[5],s=t[6],u=t[7],c=t[8],b=t[9],l=t[10],f=t[11],h=t[12],d=t[13],m=t[14],p=t[15],v=e*o-n*a,g=e*s-r*a,M=e*u-i*a,x=n*s-r*o,y=n*u-i*o,w=r*u-i*s,T=c*d-b*h,E=c*m-l*h,S=c*p-f*h,R=b*m-l*d,_=b*p-f*d,L=l*p-f*m;return v*L-g*_+M*R+x*S-y*E+w*T},f.multiply=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=e[6],b=e[7],l=e[8],f=e[9],h=e[10],d=e[11],m=e[12],p=e[13],v=e[14],g=e[15],M=n[0],x=n[1],y=n[2],w=n[3];return t[0]=M*r+x*s+y*l+w*m,t[1]=M*i+x*u+y*f+w*p,t[2]=M*a+x*c+y*h+w*v,t[3]=M*o+x*b+y*d+w*g,M=n[4],x=n[5],y=n[6],w=n[7],t[4]=M*r+x*s+y*l+w*m,t[5]=M*i+x*u+y*f+w*p,t[6]=M*a+x*c+y*h+w*v,t[7]=M*o+x*b+y*d+w*g,M=n[8],x=n[9],y=n[10],w=n[11],t[8]=M*r+x*s+y*l+w*m,t[9]=M*i+x*u+y*f+w*p,t[10]=M*a+x*c+y*h+w*v,t[11]=M*o+x*b+y*d+w*g,M=n[12],x=n[13],y=n[14],w=n[15],t[12]=M*r+x*s+y*l+w*m,t[13]=M*i+x*u+y*f+w*p,t[14]=M*a+x*c+y*h+w*v,t[15]=M*o+x*b+y*d+w*g,t},f.mul=f.multiply,f.translate=function(t,e,n){var r,i,a,o,s,u,c,b,l,f,h,d,m=n[0],p=n[1],v=n[2];return e===t?(t[12]=e[0]*m+e[4]*p+e[8]*v+e[12],t[13]=e[1]*m+e[5]*p+e[9]*v+e[13],t[14]=e[2]*m+e[6]*p+e[10]*v+e[14],t[15]=e[3]*m+e[7]*p+e[11]*v+e[15]):(r=e[0],i=e[1],a=e[2],o=e[3],s=e[4],u=e[5],c=e[6],b=e[7],l=e[8],f=e[9],h=e[10],d=e[11],t[0]=r,t[1]=i,t[2]=a,t[3]=o,t[4]=s,t[5]=u,t[6]=c,t[7]=b,t[8]=l,t[9]=f,t[10]=h,t[11]=d,t[12]=r*m+s*p+l*v+e[12],t[13]=i*m+u*p+f*v+e[13],t[14]=a*m+c*p+h*v+e[14],t[15]=o*m+b*p+d*v+e[15]),t},f.scale=function(t,e,n){var r=n[0],i=n[1],a=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*a,t[9]=e[9]*a,t[10]=e[10]*a,t[11]=e[11]*a,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},f.rotate=function(t,n,r,i){var a,o,s,u,c,b,l,f,h,d,m,p,v,g,M,x,y,w,T,E,S,R,_,L,A=i[0],P=i[1],D=i[2],C=Math.sqrt(A*A+P*P+D*D);return Math.abs(C)<e?null:(C=1/C,A*=C,P*=C,D*=C,a=Math.sin(r),o=Math.cos(r),s=1-o,u=n[0],c=n[1],b=n[2],l=n[3],f=n[4],h=n[5],d=n[6],m=n[7],p=n[8],v=n[9],g=n[10],M=n[11],x=A*A*s+o,y=P*A*s+D*a,w=D*A*s-P*a,T=A*P*s-D*a,E=P*P*s+o,S=D*P*s+A*a,R=A*D*s+P*a,_=P*D*s-A*a,L=D*D*s+o,t[0]=u*x+f*y+p*w,t[1]=c*x+h*y+v*w,t[2]=b*x+d*y+g*w,t[3]=l*x+m*y+M*w,t[4]=u*T+f*E+p*S,t[5]=c*T+h*E+v*S,t[6]=b*T+d*E+g*S,t[7]=l*T+m*E+M*S,t[8]=u*R+f*_+p*L,t[9]=c*R+h*_+v*L,t[10]=b*R+d*_+g*L,t[11]=l*R+m*_+M*L,n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t)},f.rotateX=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),a=e[4],o=e[5],s=e[6],u=e[7],c=e[8],b=e[9],l=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=a*i+c*r,t[5]=o*i+b*r,t[6]=s*i+l*r,t[7]=u*i+f*r,t[8]=c*i-a*r,t[9]=b*i-o*r,t[10]=l*i-s*r,t[11]=f*i-u*r,t},f.rotateY=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),a=e[0],o=e[1],s=e[2],u=e[3],c=e[8],b=e[9],l=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i-c*r,t[1]=o*i-b*r,t[2]=s*i-l*r,t[3]=u*i-f*r,t[8]=a*r+c*i,t[9]=o*r+b*i,t[10]=s*r+l*i,t[11]=u*r+f*i,t},f.rotateZ=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),a=e[0],o=e[1],s=e[2],u=e[3],c=e[4],b=e[5],l=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*i+c*r,t[1]=o*i+b*r,t[2]=s*i+l*r,t[3]=u*i+f*r,t[4]=c*i-a*r,t[5]=b*i-o*r,t[6]=l*i-s*r,t[7]=f*i-u*r,t},f.fromRotationTranslation=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=r+r,u=i+i,c=a+a,b=r*s,l=r*u,f=r*c,h=i*u,d=i*c,m=a*c,p=o*s,v=o*u,g=o*c;return t[0]=1-(h+m),t[1]=l+g,t[2]=f-v,t[3]=0,t[4]=l-g,t[5]=1-(b+m),t[6]=d+p,t[7]=0,t[8]=f+v,t[9]=d-p,t[10]=1-(b+h),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t},f.fromQuat=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n+n,s=r+r,u=i+i,c=n*o,b=r*o,l=r*s,f=i*o,h=i*s,d=i*u,m=a*o,p=a*s,v=a*u;return t[0]=1-l-d,t[1]=b+v,t[2]=f-p,t[3]=0,t[4]=b-v,t[5]=1-c-d,t[6]=h+m,t[7]=0,t[8]=f+p,t[9]=h-m,t[10]=1-c-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},f.frustum=function(t,e,n,r,i,a,o){var s=1/(n-e),u=1/(i-r),c=1/(a-o);return t[0]=2*a*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*a*u,t[6]=0,t[7]=0,t[8]=(n+e)*s,t[9]=(i+r)*u,t[10]=(o+a)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*a*2*c,t[15]=0,t},f.perspective=function(t,e,n,r,i){var a=1/Math.tan(e/2),o=1/(r-i);return t[0]=a/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+r)*o,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*r*o,t[15]=0,t},f.ortho=function(t,e,n,r,i,a,o){var s=1/(e-n),u=1/(r-i),c=1/(a-o);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+n)*s,t[13]=(i+r)*u,t[14]=(o+a)*c,t[15]=1,t},f.lookAt=function(t,n,r,i){var a,o,s,u,c,b,l,h,d,m,p=n[0],v=n[1],g=n[2],M=i[0],x=i[1],y=i[2],w=r[0],T=r[1],E=r[2];return Math.abs(p-w)<e&&Math.abs(v-T)<e&&Math.abs(g-E)<e?f.identity(t):(l=p-w,h=v-T,d=g-E,m=1/Math.sqrt(l*l+h*h+d*d),l*=m,h*=m,d*=m,a=x*d-y*h,o=y*l-M*d,s=M*h-x*l,m=Math.sqrt(a*a+o*o+s*s),m?(m=1/m,a*=m,o*=m,s*=m):(a=0,o=0,s=0),u=h*s-d*o,c=d*a-l*s,b=l*o-h*a,m=Math.sqrt(u*u+c*c+b*b),m?(m=1/m,u*=m,c*=m,b*=m):(u=0,c=0,b=0),t[0]=a,t[1]=u,t[2]=l,t[3]=0,t[4]=o,t[5]=c,t[6]=h,t[7]=0,t[8]=s,t[9]=b,t[10]=d,t[11]=0,t[12]=-(a*p+o*v+s*g),t[13]=-(u*p+c*v+b*g),t[14]=-(l*p+h*v+d*g),t[15]=1,t)},f.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},f.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},"undefined"!=typeof t&&(t.mat4=f);var h={};h.create=function(){var t=new n(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},h.rotationTo=function(){var t=s.create(),e=s.fromValues(1,0,0),n=s.fromValues(0,1,0);return function(r,i,a){var o=s.dot(i,a);return-.999999>o?(s.cross(t,e,i),s.length(t)<1e-6&&s.cross(t,n,i),s.normalize(t,t),h.setAxisAngle(r,t,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(s.cross(t,i,a),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=1+o,h.normalize(r,r))}}(),h.setAxes=function(){var t=l.create();return function(e,n,r,i){return t[0]=r[0],t[3]=r[1],t[6]=r[2],t[1]=i[0],t[4]=i[1],t[7]=i[2],t[2]=-n[0],t[5]=-n[1],t[8]=-n[2],h.normalize(e,h.fromMat3(e,t))}}(),h.clone=u.clone,h.fromValues=u.fromValues,h.copy=u.copy,h.set=u.set,h.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},h.setAxisAngle=function(t,e,n){n=.5*n;var r=Math.sin(n);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(n),t},h.add=u.add,h.multiply=function(t,e,n){var r=e[0],i=e[1],a=e[2],o=e[3],s=n[0],u=n[1],c=n[2],b=n[3];return t[0]=r*b+o*s+i*c-a*u,t[1]=i*b+o*u+a*s-r*c,t[2]=a*b+o*c+r*u-i*s,t[3]=o*b-r*s-i*u-a*c,t},h.mul=h.multiply,h.scale=u.scale,h.rotateX=function(t,e,n){n*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(n),u=Math.cos(n);return t[0]=r*u+o*s,t[1]=i*u+a*s,t[2]=a*u-i*s,t[3]=o*u-r*s,t},h.rotateY=function(t,e,n){n*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(n),u=Math.cos(n);return t[0]=r*u-a*s,t[1]=i*u+o*s,t[2]=a*u+r*s,t[3]=o*u-i*s,t},h.rotateZ=function(t,e,n){n*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],s=Math.sin(n),u=Math.cos(n);return t[0]=r*u+i*s,t[1]=i*u-r*s,t[2]=a*u+o*s,t[3]=o*u-a*s,t},h.calculateW=function(t,e){var n=e[0],r=e[1],i=e[2];return t[0]=n,t[1]=r,t[2]=i,t[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),t},h.dot=u.dot,h.lerp=u.lerp,h.slerp=function(t,e,n,r){var i,a,o,s,u,c=e[0],b=e[1],l=e[2],f=e[3],h=n[0],d=n[1],m=n[2],p=n[3];return a=c*h+b*d+l*m+f*p,0>a&&(a=-a,h=-h,d=-d,m=-m,p=-p),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-r)*i)/o,u=Math.sin(r*i)/o):(s=1-r,u=r),t[0]=s*c+u*h,t[1]=s*b+u*d,t[2]=s*l+u*m,t[3]=s*f+u*p,t},h.invert=function(t,e){var n=e[0],r=e[1],i=e[2],a=e[3],o=n*n+r*r+i*i+a*a,s=o?1/o:0;return t[0]=-n*s,t[1]=-r*s,t[2]=-i*s,t[3]=a*s,t},h.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},h.length=u.length,h.len=h.length,h.squaredLength=u.squaredLength,h.sqrLen=h.squaredLength,h.normalize=u.normalize,h.fromMat3=function(t,e){var n,r=e[0]+e[4]+e[8];if(r>0)n=Math.sqrt(r+1),t[3]=.5*n,n=.5/n,t[0]=(e[7]-e[5])*n,t[1]=(e[2]-e[6])*n,t[2]=(e[3]-e[1])*n;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;n=Math.sqrt(e[3*i+i]-e[3*a+a]-e[3*o+o]+1),t[i]=.5*n,n=.5/n,t[3]=(e[3*o+a]-e[3*a+o])*n,t[a]=(e[3*a+i]+e[3*i+a])*n,t[o]=(e[3*o+i]+e[3*i+o])*n}return t},h.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},"undefined"!=typeof t&&(t.quat=h)}(e.exports)}(this),n("program",[],function(){"use strict";log("executing module program.js");var t=[],e=function(t,e,n){var r=t.getShaderParameter(e,t.COMPILE_STATUS);if(!r){var i=t.getShaderInfoLog(e);throw n+": "+i}return!0},n=function(t,n,r){this.gl=t,this.glProgram=t.createProgram();var i=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(i,n),t.compileShader(i),!e(t,i,"vertex shader"))return null;t.attachShader(this.glProgram,i);var a=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(a,r),t.compileShader(a),!e(t,a,"fragment shader"))return null;if(t.attachShader(this.glProgram,a),t.linkProgram(this.glProgram),!t.getProgramParameter(this.glProgram,t.LINK_STATUS))throw"linking error: "+t.getProgramInfoLog(this.glProgram)};return n.prototype.use=function(){t[this.gl]===this||(this.gl.useProgram(this.glProgram),t[this.gl]=this)},n.prototype.getAttribLocation=function(t){return this.gl.getAttribLocation(this.glProgram,t)},n.prototype.glRenderContext=function(){return this.gl},n.prototype.glProgramObject=function(){return this.glProgram},n.prototype.setUniform=function(t,e,n,r){void 0===r&&(r=!0);var i=this.gl.getUniformLocation(this.glProgram,t);if(null==i)r&&log("WARNING: uniform variable "+t+" not used in shader.");else switch(e){case"mat4":return this.gl.uniformMatrix4fv(i,!1,n),!0;case"mat3":return this.gl.uniformMatrix3fv(i,!1,n),!0;case"mat2":return this.gl.uniformMatrix2fv(i,!1,n),!0;case"vec4":return this.gl.uniform4fv(i,n),!0;case"vec3":return this.gl.uniform3fv(i,n),!0;
case"vec2":return this.gl.uniform2fv(i,n),!0;case"float":return this.gl.uniform1f(i,n),!0;case"int":return this.gl.uniform1i(i,n),!0;case"bool":return this.gl.uniform1i(i,n),!0;default:throw new Error("setUniform(): unknown uniform type '"+e+"'")}return!1},n.prototype.setTexture=function(t,e,n,r){if(void 0===r&&(r=!0),!n.isLoaded)throw new Error("setTexture(): not a valid texture wrapper object.");if(!n.isLoaded())return log("info: image file for texture "+t+" not loaded yet."),!1;var i=this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS;if(0>e||e>=i)throw new Error("ERROR: setTexture(): texture unit "+e+" out of range [0 ... "+i-1+"]");var a=this.gl.getUniformLocation(this.glProgram,t);return null===a||0>a?void log("uniform sampler "+t+" not used in shader."):(this.gl.uniform1i(a,e),this.gl.activeTexture(this.gl.TEXTURE0+e),void this.gl.bindTexture(this.gl.TEXTURE_2D,n.glTextureObject()))},n}),n("scene_node",["gl-matrix"],function(t){"use strict";var e=function(e,n,r,i,a){this.name=e,this.drawableObjects=n||[],this.program=r||null,this.transformation=i||t.mat4.create(),this.visible=void 0===a?!0:a,log("created "+(a?"invisible ":"")+"node "+this.name+" with "+this.drawableObjects.length+" children.")};return e.prototype.draw=function(e,n,r){if(this.visible){if(!e)throw"no WebGL context specified in scene node "+this.name;var i=this.program||n;if(!i)throw"no program specified in scene node "+this.name;var a=r?t.mat4.clone(r):t.mat4.create();t.mat4.multiply(a,a,this.transformation);var o=t.mat3.fromMat4(t.mat3.create(),t.mat4.invert(t.mat4.create(),a));t.mat3.transpose(o,o);for(var s=0;s<this.drawableObjects.length;++s)i.use(),i.setUniform("modelViewMatrix","mat4",a),i.setUniform("normalMatrix","mat3",o,!1),this.drawableObjects[s].draw(e,i,a)}},e.prototype.addObjects=function(t){for(var e=0;e<t.length;e++){var n=t[e];if(!n.draw)throw"addObjects(): object "+e+" has no draw() method.";this.drawableObjects.push(n)}log("added "+t.length+" objects to SceneNode "+this.name+".")},e.prototype.removeObjects=function(t){for(var e=0;e<t.length;e++){var n=this.drawableObjects.indexOf(t[e]);-1===n||this.drawableObjects.splice(n,1)}},e.prototype.Custom=function(t){this.draw=t},e}),n("texture",[],function(){"use strict";var t=0,e=function(t){i=t},n=function(t,e,n){if(this.gl=t,this.useMipMap=void 0===e?!1:e,this.callback=n,this.gltex=t.createTexture(),!this.gltex)throw"could not create WebGL texture";this.resetTexParameters()};n.prototype.init_1=function(e){this.loadingCompleted=!1,t++;var n=new Image,r=this;return n.onload=function(){r.handleLoadedImage(n)},n.src=e,this},n.prototype.init_2=function(t,e,n){var r=this.gl;return this.loadingCompleted=!0,r.bindTexture(r.TEXTURE_2D,this.gltex),r.texImage2D(r.TEXTURE_2D,0,r.RGB,t,e,0,r.RGB,r.UNSIGNED_BYTE,n),this.useMipMap&&r.generateMipmap(r.TEXTURE_2D),this.callback&&this.callback(),this},n.prototype.resetTexParameters=function(){var t=this.gl;t.bindTexture(t.TEXTURE_2D,this.gltex),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),this.useMipMap?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR))},n.prototype.setTexParameter=function(t,e){var n=this.gl;n.bindTexture(n.TEXTURE_2D,this.gltex),n.texParameteri(n.TEXTURE_2D,t,e)},n.prototype.isLoaded=function(){return this.loadingCompleted},n.prototype.glTextureObject=function(){return this.gltex},n.prototype.handleLoadedImage=function(e){var n=this.gl;this.loadingCompleted=!0,log("texture "+e.src+" loaded."),n.bindTexture(n.TEXTURE_2D,this.gltex),n.texImage2D(n.TEXTURE_2D,0,n.RGB,n.RGB,n.UNSIGNED_BYTE,e),this.useMipMap&&n.generateMipmap(n.TEXTURE_2D),this.callback&&this.callback(),t--,0==t&&i&&i()};var r=function(){log("TextureCube not implemented.")},i=function(){log("all textures have been loaded")};return{onAllTexturesLoaded:e,Texture2D:n,TextureCube:r}}),n("light",[],function(){"use strict";var t=0,e=function(t,e){e=e||{},this.uniformName=t||"light",this.direction=e.direction||[-1,0,0],this.color=e.color||[1,0,0],this.on=e.on||!0};return e.prototype.draw=function(e,n,r){var i=mat4.toInverseMat3(r||mat4.identity());mat3.transpose(i,i);var a=vec3.create(this.direction);mat3.multiplyVec3(i,a);var o=this.uniformName;n.use(),n.setUniform(o+".type","int",t),n.setUniform(o+".on","bool",this.on),n.setUniform(o+".direction","vec3",a),n.setUniform(o+".color","vec3",this.color)},{DirectionalLight:e}}),n("material",[],function(){"use strict";var t=function(t,e){e=e||{},this.uniformName=t||"material",this.ambient=e.ambient||[0,0,0],this.diffuse=e.diffuse||[.4,0,0],this.specular=e.specular||[.6,.6,.6],this.shininess=e.shininess||40};return t.prototype.draw=function(t,e){var n=this.uniformName;e.use(),e.setUniform(n+".ambient","vec3",this.ambient),e.setUniform(n+".diffuse","vec3",this.diffuse),e.setUniform(n+".specular","vec3",this.specular),e.setUniform(n+".shininess","float",this.shininess)},{PhongMaterial:t}}),n("vbo",[],function(){"use strict";var t={};return t.Attribute=function(t,e){this.numComponents=e.numComponents,this.dataType=e.dataType||t.FLOAT,this.warnUnused=e.warnUnused,void 0===this.warnUnused&&(this.warnUnused=!1);var n=e.data;this.numVert=n.length/this.numComponents,n instanceof Float32Array||(n=new Float32Array(n)),this.glBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.glBuffer),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW)},t.Attribute.prototype.bind=function(t,e,n){e.use();var r=e.getAttribLocation(n);return 0>r?void(this.warnUnused&&log("vertex attribute "+n+" not used in vertex shader.")):(t.bindBuffer(t.ARRAY_BUFFER,this.glBuffer),t.vertexAttribPointer(r,this.numComponents,this.dataType,!1,0,0),void t.enableVertexAttribArray(r))},t.Attribute.prototype.numVertices=function(){return this.numVert},t.Indices=function(t,e){var n=e.indices;this.numElements=n.length,this.glBuffer=t.createBuffer(),n instanceof Uint16Array||(n=new Uint16Array(n)),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.glBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW)},t.Indices.prototype.numIndices=function(){return this.numElements},t.Indices.prototype.bind=function(t){t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.glBuffer)},t}),n("stage",["vbo"],function(t){"use strict";var e=function(e){var n=[-1,-1,-2,1,-1,-2,-1,1,-2,1,1,-2],r=[0,0,1,0,0,1,1,1];this.coordsBuffer=new t.Attribute(e,{numComponents:3,dataType:e.FLOAT,data:n}),this.texCoordsBuffer=new t.Attribute(e,{numComponents:2,dataType:e.FLOAT,data:r})};return e.prototype.draw=function(t,e){this.coordsBuffer.bind(t,e,"vertexPosition"),this.texCoordsBuffer.bind(t,e,"vertexTexCoords"),t.drawArrays(t.TRIANGLE_STRIP,0,this.coordsBuffer.numVertices())},e}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return this.slice(0,t.length)===t}),n("mesh",[],function(){var t=function(t){"use strict";var e=[],n=[],r=[],i={};i.verts=[],i.norms=[],i.textures=[],i.hashindices={},i.indices=[],i.index=0;for(var a=t.split("\n"),o=0;o<a.length;o++){var s="";if(a[o].startsWith("v "))s=a[o].slice(2).split(" "),e.push(s[0]),e.push(s[1]),e.push(s[2]);else if(a[o].startsWith("vn"))s=a[o].slice(3).split(" "),n.push(s[0]),n.push(s[1]),n.push(s[2]);else if(a[o].startsWith("vt"))s=a[o].slice(3).split(" "),r.push(s[0]),r.push(s[1]);else if(a[o].startsWith("f ")){s=a[o].slice(2).split(" ");for(var u=!1,c=0;c<s.length;c++){if(3!=c||u||(c=2,u=!0),s[c]in i.hashindices)i.indices.push(i.hashindices[s[c]]);else{var b=s[c].split("/");i.verts.push(e[3*(b[0]-1)+0]),i.verts.push(e[3*(b[0]-1)+1]),i.verts.push(e[3*(b[0]-1)+2]),i.textures.push(r[2*(b[1]-1)+0]),i.textures.push(r[2*(b[1]-1)+1]),i.norms.push(n[3*(b[2]-1)+0]),i.norms.push(n[3*(b[2]-1)+1]),i.norms.push(n[3*(b[2]-1)+2]),i.hashindices[s[c]]=i.index,i.indices.push(i.index),i.index+=1}3==c&&u&&i.indices.push(i.hashindices[s[0]])}}}this.vertices=i.verts,this.vertexNormals=i.norms,this.textures=i.textures,this.indices=i.indices};return t}),n("Config",[],function(){var t={MESH_SAMPLER_WIDTH:256,MESH_SAMPLER_HEIGHT:4},e=function(){};return e.prototype.get=function(e){return t[e]},e});var r={};return function(t,e){function n(t,e,n){var r;return e&&"object"==typeof e&&(null!=e[t]?r=e[t]:n&&e.get&&"function"==typeof e.get&&(r=e.get(t))),r}function r(t,e,n,r){function i(){}function a(){}i.prototype=t,a.prototype=t.subs;var o,s=new i;s.subs=new a,s.subsText={},s.ib();for(o in e)s.subs[o]=e[o],s.subsText[o]=r;for(o in n)s.partials[o]=n[o];return s}function i(t){return String(null===t||void 0===t?"":t)}function a(t){return t=i(t),l.test(t)?t.replace(o,"&amp;").replace(s,"&lt;").replace(u,"&gt;").replace(c,"&#39;").replace(b,"&quot;"):t}t.Template=function(t,e,n,r){t=t||{},this.r=t.code||this.r,this.c=n,this.options=r||{},this.text=e||"",this.partials=t.partials||{},this.subs=t.subs||{},this.ib()},t.Template.prototype={r:function(){return""},v:a,t:i,render:function(t,e,n){return this.ri([t],e||{},n)},ri:function(t,e,n){return this.r(t,e,n)},ep:function(t,e){var n=this.partials[t],i=e[n.name];if(n.instance&&n.base==i)return n.instance;if("string"==typeof i){if(!this.c)throw new Error("No compiler available.");i=this.c.compile(i,this.options)}return i?(this.partials[t].base=i,n.subs&&(void 0===this.activeSub&&(e.stackText=this.text),i=r(i,n.subs,n.partials,e.stackText||this.text)),this.partials[t].instance=i,i):null},rp:function(t,e,n,r){var i=this.ep(t,n);return i?i.ri(e,n,r):""},rs:function(t,e,n){var r=t[t.length-1];if(!f(r))return void n(t,e,this);for(var i=0;i<r.length;i++)t.push(r[i]),n(t,e,this),t.pop()},s:function(t,e,n,r,i,a,o){var s;return f(t)&&0===t.length?!1:("function"==typeof t&&(t=this.ms(t,e,n,r,i,a,o)),s=!!t,!r&&s&&e&&e.push("object"==typeof t?t:e[e.length-1]),s)},d:function(t,e,r,i){var a,o=t.split("."),s=this.f(o[0],e,r,i),u=this.options.modelGet,c=null;if("."===t&&f(e[e.length-2]))s=e[e.length-1];else for(var b=1;b<o.length;b++)a=n(o[b],s,u),null!=a?(c=s,s=a):s="";return i&&!s?!1:(i||"function"!=typeof s||(e.push(c),s=this.mv(s,e,r),e.pop()),s)},f:function(t,e,r,i){for(var a=!1,o=null,s=!1,u=this.options.modelGet,c=e.length-1;c>=0;c--)if(o=e[c],a=n(t,o,u),null!=a){s=!0;break}return s?(i||"function"!=typeof a||(a=this.mv(a,e,r)),a):i?!1:""},ls:function(t,e,n,r,a){var o=this.options.delimiters;return this.options.delimiters=a,this.b(this.ct(i(t.call(e,r)),e,n)),this.options.delimiters=o,!1},ct:function(t,e,n){if(this.options.disableLambda)throw new Error("Lambda features disabled.");return this.c.compile(t,this.options).render(e,n)},b:e?function(t){this.buf.push(t)}:function(t){this.buf+=t},fl:e?function(){var t=this.buf.join("");return this.buf=[],t}:function(){var t=this.buf;return this.buf="",t},ib:function(){this.buf=e?[]:""},ms:function(t,e,n,r,i,a,o){var s,u=e[e.length-1],c=t.call(u);return"function"==typeof c?r?!0:(s=this.activeSub&&this.subsText[this.activeSub]?this.subsText[this.activeSub]:this.text,this.ls(c,u,n,s.substring(i,a),o)):c},mv:function(t,e,n){var r=e[e.length-1],a=t.call(r);return"function"==typeof a?this.ct(i(a.call(r)),r,n):a},sub:function(t,e,n,r){var i=this.subs[t];i&&(this.activeSub=t,i(e,n,this,r),this.activeSub=!1)}};var o=/&/g,s=/</g,u=/>/g,c=/\'/g,b=/\"/g,l=/[&<>\"\']/,f=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)}}("undefined"!=typeof exports?exports:r),function(t){function e(t){"}"===t.n.substr(t.n.length-1)&&(t.n=t.n.substring(0,t.n.length-1))}function n(t){return t.trim?t.trim():t.replace(/^\s*|\s*$/g,"")}function r(t,e,n){if(e.charAt(n)!=t.charAt(0))return!1;for(var r=1,i=t.length;i>r;r++)if(e.charAt(n+r)!=t.charAt(r))return!1;return!0}function i(e,n,r,s){var u=[],c=null,b=null,l=null;for(b=r[r.length-1];e.length>0;){if(l=e.shift(),b&&"<"==b.tag&&!(l.tag in M))throw new Error("Illegal content in < super tag.");if(t.tags[l.tag]<=t.tags.$||a(l,s))r.push(l),l.nodes=i(e,l.tag,r,s);else{if("/"==l.tag){if(0===r.length)throw new Error("Closing tag without opener: /"+l.n);if(c=r.pop(),l.n!=c.n&&!o(l.n,c.n,s))throw new Error("Nesting error: "+c.n+" vs. "+l.n);return c.end=l.i,u}"\n"==l.tag&&(l.last=0==e.length||"\n"==e[0].tag)}u.push(l)}if(r.length>0)throw new Error("missing closing tag: "+r.pop().n);return u}function a(t,e){for(var n=0,r=e.length;r>n;n++)if(e[n].o==t.n)return t.tag="#",!0}function o(t,e,n){for(var r=0,i=n.length;i>r;r++)if(n[r].c==t&&n[r].o==e)return!0}function s(t){var e=[];for(var n in t)e.push('"'+c(n)+'": function(c,p,t,i) {'+t[n]+"}");return"{ "+e.join(",")+" }"}function u(t){var e=[];for(var n in t.partials)e.push('"'+c(n)+'":{name:"'+c(t.partials[n].name)+'", '+u(t.partials[n])+"}");return"partials: {"+e.join(",")+"}, subs: "+s(t.subs)}function c(t){return t.replace(g,"\\\\").replace(m,'\\"').replace(p,"\\n").replace(v,"\\r")}function b(t){return~t.indexOf(".")?"d":"f"}function l(t,e){var n="<"+(e.prefix||""),r=n+t.n+x++;return e.partials[r]={name:t.n,partials:{}},e.code+='t.b(t.rp("'+c(r)+'",c,p,"'+(t.indent||"")+'"));',r}function f(t,e){e.code+="t.b(t.t(t."+b(t.n)+'("'+c(t.n)+'",c,p,0)));'}function h(t){return"t.b("+t+");"}var d=/\S/,m=/\"/g,p=/\n/g,v=/\r/g,g=/\\/g;t.tags={"#":1,"^":2,"<":3,$:4,"/":5,"!":6,">":7,"=":8,_v:9,"{":10,"&":11,_t:12},t.scan=function(i,a){function o(){g.length>0&&(M.push({tag:"_t",text:new String(g)}),g="")}function s(){for(var e=!0,n=w;n<M.length;n++)if(e=t.tags[M[n].tag]<t.tags._v||"_t"==M[n].tag&&null===M[n].text.match(d),!e)return!1;return e}function u(t,e){if(o(),t&&s())for(var n,r=w;r<M.length;r++)M[r].text&&((n=M[r+1])&&">"==n.tag&&(n.indent=M[r].text.toString()),M.splice(r,1));else e||M.push({tag:"\n"});x=!1,w=M.length}function c(t,e){var r="="+E,i=t.indexOf(r,e),a=n(t.substring(t.indexOf("=",e)+1,i)).split(" ");return T=a[0],E=a[a.length-1],i+r.length-1}var b=i.length,l=0,f=1,h=2,m=l,p=null,v=null,g="",M=[],x=!1,y=0,w=0,T="{{",E="}}";for(a&&(a=a.split(" "),T=a[0],E=a[1]),y=0;b>y;y++)m==l?r(T,i,y)?(--y,o(),m=f):"\n"==i.charAt(y)?u(x):g+=i.charAt(y):m==f?(y+=T.length-1,v=t.tags[i.charAt(y+1)],p=v?i.charAt(y+1):"_v","="==p?(y=c(i,y),m=l):(v&&y++,m=h),x=y):r(E,i,y)?(M.push({tag:p,n:n(g),otag:T,ctag:E,i:"/"==p?x-T.length:y+E.length}),g="",y+=E.length-1,m=l,"{"==p&&("}}"==E?y++:e(M[M.length-1]))):g+=i.charAt(y);return u(x,!0),M};var M={_t:!0,"\n":!0,$:!0,"/":!0};t.stringify=function(e){return"{code: function (c,p,i) { "+t.wrapMain(e.code)+" },"+u(e)+"}"};var x=0;t.generate=function(e,n,r){x=0;var i={code:"",subs:{},partials:{}};return t.walk(e,i),r.asString?this.stringify(i,n,r):this.makeTemplate(i,n,r)},t.wrapMain=function(t){return'var t=this;t.b(i=i||"");'+t+"return t.fl();"},t.template=t.Template,t.makeTemplate=function(t,e,n){var r=this.makePartials(t);return r.code=new Function("c","p","i",this.wrapMain(t.code)),new this.template(r,e,this,n)},t.makePartials=function(t){var e,n={subs:{},partials:t.partials,name:t.name};for(e in n.partials)n.partials[e]=this.makePartials(n.partials[e]);for(e in t.subs)n.subs[e]=new Function("c","p","t","i",t.subs[e]);return n},t.codegen={"#":function(e,n){n.code+="if(t.s(t."+b(e.n)+'("'+c(e.n)+'",c,p,1),c,p,0,'+e.i+","+e.end+',"'+e.otag+" "+e.ctag+'")){t.rs(c,p,function(c,p,t){',t.walk(e.nodes,n),n.code+="});c.pop();}"},"^":function(e,n){n.code+="if(!t.s(t."+b(e.n)+'("'+c(e.n)+'",c,p,1),c,p,1,0,0,"")){',t.walk(e.nodes,n),n.code+="};"},">":l,"<":function(e,n){var r={partials:{},code:"",subs:{},inPartial:!0};t.walk(e.nodes,r);var i=n.partials[l(e,n)];i.subs=r.subs,i.partials=r.partials},$:function(e,n){var r={subs:{},code:"",partials:n.partials,prefix:e.n};t.walk(e.nodes,r),n.subs[e.n]=r.code,n.inPartial||(n.code+='t.sub("'+c(e.n)+'",c,p,i);')},"\n":function(t,e){e.code+=h('"\\n"'+(t.last?"":" + i"))},_v:function(t,e){e.code+="t.b(t.v(t."+b(t.n)+'("'+c(t.n)+'",c,p,0)));'},_t:function(t,e){e.code+=h('"'+c(t.text)+'"')},"{":f,"&":f},t.walk=function(e,n){for(var r,i=0,a=e.length;a>i;i++)r=t.codegen[e[i].tag],r&&r(e[i],n);return n},t.parse=function(t,e,n){return n=n||{},i(t,"",[],n.sectionTags||[])},t.cache={},t.cacheKey=function(t,e){return[t,!!e.asString,!!e.disableLambda,e.delimiters,!!e.modelGet].join("||")},t.compile=function(e,n){n=n||{};var r=t.cacheKey(e,n),i=this.cache[r];return i?i:(i=this.generate(this.parse(this.scan(e,n.delimiters),e,n),e,n),this.cache[r]=i)}}("undefined"!=typeof exports?exports:r),"function"==typeof n&&n.amd&&n("hogan",r),n("text",["module"],function(t){"use strict";var n,r,i,a,o,s=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],u=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,c=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,b="undefined"!=typeof location&&location.href,l=b&&location.protocol&&location.protocol.replace(/\:/,""),f=b&&location.hostname,h=b&&(location.port||void 0),d={},m=t.config&&t.config()||{};return n={version:"2.0.10",strip:function(t){if(t){t=t.replace(u,"");var e=t.match(c);e&&(t=e[1])}else t="";return t},jsEscape:function(t){return t.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:m.createXhr||function(){var t,e,n;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(e=0;3>e;e+=1){n=s[e];try{t=new ActiveXObject(n)}catch(r){}if(t){s=[n];break}}return t},parseName:function(t){var e,n,r,i=!1,a=t.indexOf("."),o=0===t.indexOf("./")||0===t.indexOf("../");return-1!==a&&(!o||a>1)?(e=t.substring(0,a),n=t.substring(a+1,t.length)):e=t,r=n||e,a=r.indexOf("!"),-1!==a&&(i="strip"===r.substring(a+1),r=r.substring(0,a),n?n=r:e=r),{moduleName:e,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(t,e,r,i){var a,o,s,u=n.xdRegExp.exec(t);return u?(a=u[2],o=u[3],o=o.split(":"),s=o[1],o=o[0],!(a&&a!==e||o&&o.toLowerCase()!==r.toLowerCase()||(s||o)&&s!==i)):!0},finishLoad:function(t,e,r,i){r=e?n.strip(r):r,m.isBuild&&(d[t]=r),i(r)},load:function(t,e,r,i){if(i.isBuild&&!i.inlineText)return void r();m.isBuild=i.isBuild;var a=n.parseName(t),o=a.moduleName+(a.ext?"."+a.ext:""),s=e.toUrl(o),u=m.useXhr||n.useXhr;return 0===s.indexOf("empty:")?void r():void(!b||u(s,l,f,h)?n.get(s,function(e){n.finishLoad(t,a.strip,e,r)},function(t){r.error&&r.error(t)}):e([o],function(t){n.finishLoad(a.moduleName+"."+a.ext,a.strip,t,r)}))},write:function(t,e,r){if(d.hasOwnProperty(e)){var i=n.jsEscape(d[e]);r.asModule(t+"!"+e,"define(function () { return '"+i+"';});\n")}},writeFile:function(t,e,r,i,a){var o=n.parseName(e),s=o.ext?"."+o.ext:"",u=o.moduleName+s,c=r.toUrl(o.moduleName+s)+".js";n.load(u,r,function(){var e=function(t){return i(c,t)};e.asModule=function(t,e){return i.asModule(t,c,e)},n.write(t,u,e,a)},a)}},"node"===m.env||!m.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]?(r=e.nodeRequire("fs"),n.get=function(t,e,n){try{var i=r.readFileSync(t,"utf8");0===i.indexOf("﻿")&&(i=i.substring(1)),e(i)}catch(a){n(a)}}):"xhr"===m.env||!m.env&&n.createXhr()?n.get=function(t,e,r,i){var a,o=n.createXhr();if(o.open("GET",t,!0),i)for(a in i)i.hasOwnProperty(a)&&o.setRequestHeader(a.toLowerCase(),i[a]);m.onXhr&&m.onXhr(o,t),o.onreadystatechange=function(){var n,i;4===o.readyState&&(n=o.status,n>399&&600>n?(i=new Error(t+" HTTP status: "+n),i.xhr=o,r(i)):e(o.responseText),m.onXhrComplete&&m.onXhrComplete(o,t))},o.send(null)}:"rhino"===m.env||!m.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?n.get=function(t,e){var n,r,i="utf-8",a=new java.io.File(t),o=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(a),i)),u="";try{for(n=new java.lang.StringBuffer,r=s.readLine(),r&&r.length()&&65279===r.charAt(0)&&(r=r.substring(1)),null!==r&&n.append(r);null!==(r=s.readLine());)n.append(o),n.append(r);u=String(n.toString())}finally{s.close()}e(u)}:("xpconnect"===m.env||!m.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(i=Components.classes,a=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),o="@mozilla.org/windows-registry-key;1"in i,n.get=function(t,e){var n,r,s,u={};o&&(t=t.replace(/\//g,"\\")),s=new FileUtils.File(t);try{n=i["@mozilla.org/network/file-input-stream;1"].createInstance(a.nsIFileInputStream),n.init(s,1,0,!1),r=i["@mozilla.org/intl/converter-input-stream;1"].createInstance(a.nsIConverterInputStream),r.init(n,"utf-8",n.available(),a.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),r.readString(n.available(),u),r.close(),n.close(),e(u.value)}catch(c){throw new Error((s&&s.path||"")+": "+c)}}),n}),n("hgn",["hogan","text"],function(t,e){function n(n,a,o,c){var b=c.hgn||{},l=n;l+=b&&null!=b.templateExtension?b.templateExtension:s,e.get(a.toUrl(l),function(e){var a=b.compilationOptions?i({},b.compilationOptions):{};c.isBuild&&(a.asString=!0,u[n]=t.compile(e,a));var s=t.compile(e,a),l=r(s.render,s);l.text=s.text,l.template=s,o(l)})}function r(t,e){return function(){return t.apply(e,arguments)}}function i(t,e){var n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}function a(e,n,r){if(n in u){o||(o=t.compile(c));var i=u[n];r(o.render({pluginName:e,moduleName:n,fn:i}))}}var o,s=".mustache",u={},c='define("{{pluginName}}!{{moduleName}}", ["hogan"], function(hogan){  var tmpl = new hogan.Template({{{fn}}}, "", hogan);  function render(){ return tmpl.render.apply(tmpl, arguments); } render.template = tmpl; return render;});\n';return{load:n,write:a}}),n("hgn!../shaders/pathtracing.vert",["hogan"],function(t){function e(){return n.render.apply(n,arguments)}var n=new t.Template({code:function(t,e,n){var r=this;return r.b(n=n||""),r.b("/**"),r.b("\n"+n),r.b(" * Pathtracing"),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" * @author Niels Garve, niels.garve.yahoo.de"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("#version 100"),r.b("\n"+n),r.b("precision mediump float;"),r.b("\n"),r.b("\n"+n),r.b("attribute vec3 vertexPosition;"),r.b("\n"+n),r.b("attribute vec2 vertexTexCoords;"),r.b("\n"),r.b("\n"+n),r.b("uniform mat4 modelViewMatrix;"),r.b("\n"+n),r.b("uniform mat4 projectionMatrix;"),r.b("\n"+n),r.b("uniform vec3 eyePosition;"),r.b("\n"),r.b("\n"+n),r.b("varying vec3 rayDirection;"),r.b("\n"+n),r.b("varying vec2 texCoords;"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * Liefert die inverse Matrix zu mat. Der Algorithmus ist gl-matrix-1.3.7.js entnommen und von mir auf GLSL portiert"),r.b("\n"+n),r.b(" * worden. Achtung: In der gl-matrix-1.3.7.js-Bibliothek passiert die Initialisierung der Matrizen in Reihen, in der "),r.b("\n"+n),r.b(" * GLSL in Spalten!"),r.b("\n"+n),r.b(" * @author vgl. Brandon Jones, Colin MacKenzie IV"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("mat4 inverse(mat4 mat) {"),r.b("\n"+n),r.b("	// Cache the matrix values (makes for huge speed increases!)"),r.b("\n"+n),r.b("	float a00 = mat[0].x; float a01 = mat[0].y; float a02 = mat[0].z; float a03 = mat[0].w;"),r.b("\n"+n),r.b("	float a10 = mat[1].x; float a11 = mat[1].y; float a12 = mat[1].z; float a13 = mat[1].w;"),r.b("\n"+n),r.b("	float a20 = mat[2].x; float a21 = mat[2].y; float a22 = mat[2].z; float a23 = mat[2].w;"),r.b("\n"+n),r.b("	float a30 = mat[3].x; float a31 = mat[3].y; float a32 = mat[3].z; float a33 = mat[3].w;"),r.b("\n"),r.b("\n"+n),r.b("	float b00 = a00 * a11 - a01 * a10;"),r.b("\n"+n),r.b("	float b01 = a00 * a12 - a02 * a10;"),r.b("\n"+n),r.b("	float b02 = a00 * a13 - a03 * a10;"),r.b("\n"+n),r.b("	float b03 = a01 * a12 - a02 * a11;"),r.b("\n"+n),r.b("	float b04 = a01 * a13 - a03 * a11;"),r.b("\n"+n),r.b("	float b05 = a02 * a13 - a03 * a12;"),r.b("\n"+n),r.b("	float b06 = a20 * a31 - a21 * a30;"),r.b("\n"+n),r.b("	float b07 = a20 * a32 - a22 * a30;"),r.b("\n"+n),r.b("	float b08 = a20 * a33 - a23 * a30;"),r.b("\n"+n),r.b("	float b09 = a21 * a32 - a22 * a31;"),r.b("\n"+n),r.b("	float b10 = a21 * a33 - a23 * a31;"),r.b("\n"+n),r.b("	float b11 = a22 * a33 - a23 * a32;"),r.b("\n"),r.b("\n"+n),r.b("	float d = (b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06);"),r.b("\n"+n),r.b("	float invDet;"),r.b("\n"),r.b("\n"+n),r.b("	// Calculate the determinant"),r.b("\n"+n),r.b("	if (d == 0.0) {"),r.b("\n"+n),r.b("		/**"),r.b("\n"+n),r.b("		 * liefer Identität TODO ok?"),r.b("\n"+n),r.b("		 * @author Niels Garve, niels.garve.yahoo.de"),r.b("\n"+n),r.b("		 */"),r.b("\n"+n),r.b("		return mat4(1.0);"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("	invDet = 1.0 / d;"),r.b("\n"),r.b("\n"+n),r.b("	return mat4("),r.b("\n"+n),r.b("		(a11 * b11 - a12 * b10 + a13 * b09) * invDet,"),r.b("\n"+n),r.b("		(-a10 * b11 + a12 * b08 - a13 * b07) * invDet,"),r.b("\n"+n),r.b("		(a10 * b10 - a11 * b08 + a13 * b06) * invDet,"),r.b("\n"+n),r.b("		(-a10 * b09 + a11 * b07 - a12 * b06) * invDet,"),r.b("\n"+n),r.b("		(-a01 * b11 + a02 * b10 - a03 * b09) * invDet,"),r.b("\n"+n),r.b("		(a00 * b11 - a02 * b08 + a03 * b07) * invDet,"),r.b("\n"+n),r.b("		(-a00 * b10 + a01 * b08 - a03 * b06) * invDet,"),r.b("\n"+n),r.b("		(a00 * b09 - a01 * b07 + a02 * b06) * invDet,"),r.b("\n"+n),r.b("		(a31 * b05 - a32 * b04 + a33 * b03) * invDet,"),r.b("\n"+n),r.b("		(-a30 * b05 + a32 * b02 - a33 * b01) * invDet,"),r.b("\n"+n),r.b("		(a30 * b04 - a31 * b02 + a33 * b00) * invDet,"),r.b("\n"+n),r.b("		(-a30 * b03 + a31 * b01 - a32 * b00) * invDet,"),r.b("\n"+n),r.b("		(-a21 * b05 + a22 * b04 - a23 * b03) * invDet,"),r.b("\n"+n),r.b("		(a20 * b05 - a22 * b02 + a23 * b01) * invDet,"),r.b("\n"+n),r.b("		(-a20 * b04 + a21 * b02 - a23 * b00) * invDet,"),r.b("\n"+n),r.b("		(a20 * b03 - a21 * b01 + a22 * b00) * invDet"),r.b("\n"+n),r.b("		);"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("void main() {"),r.b("\n"+n),r.b("	gl_Position = projectionMatrix *"),r.b("\n"+n),r.b("			  // modelViewMatrix *"),r.b("\n"+n),r.b("			  vec4(vertexPosition, 1.0);"),r.b("\n"),r.b("\n"+n),r.b("	rayDirection = (vec4(vertexPosition - eyePosition, 1.0) * inverse(modelViewMatrix)).xyz;"),r.b("\n"+n),r.b("	texCoords = vertexTexCoords;"),r.b("\n"+n),r.b("}"),r.b("\n"),r.fl()},partials:{},subs:{}},"",t);return e.template=n,e}),n("hgn!../shaders/pathtracing.frag",["hogan"],function(t){function e(){return n.render.apply(n,arguments)}var n=new t.Template({code:function(t,e,n){var r=this;return r.b(n=n||""),r.b("/**"),r.b("\n"+n),r.b(" * Pathtracing"),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" * @author Niels Garve, niels.garve.yahoo.de"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("#version 100"),r.b("\n"+n),r.b("precision mediump float;"),r.b("\n"),r.b("\n"+n),r.b("// Intervallgrenzen für Werte von t (des Skalars) bei der Schnittpunktberechnung (Rundungsfehler abfangen)"),r.b("\n"+n),r.b("#define T_MIN 0.001"),r.b("\n"+n),r.b("#define T_MAX 1000000.0"),r.b("\n"),r.b("\n"+n),r.b('// Anzahl "bounces"'),r.b("\n"+n),r.b("#define DEPTH 3"),r.b("\n"),r.b("\n"+n),r.b("#define M_PI 3.14159265359"),r.b("\n"+n),r.b("#define EPSILON 0.001"),r.b("\n"),r.b("\n"+n),r.b("#define NUMBER_OF_SPHERES "),r.b(r.v(r.f("numberOfSpheres",t,e,0))),r.b("\n"+n),r.b("#define NUMBER_OF_SPHERICAL_LIGHTS "),r.b(r.v(r.f("numberOfSphericalLights",t,e,0))),r.b("\n"+n),r.b("#define MESH_SAMPLER_WIDTH "),r.b(r.v(r.f("meshSamplerWidth",t,e,0))),r.b("\n"),r.b("\n"+n),r.b('// "struct"-Orientiertes programmieren'),r.b("\n"+n),r.b("struct Ray {"),r.b("\n"+n),r.b("	vec3 start;"),r.b("\n"+n),r.b("	vec3 direction;"),r.b("\n"+n),r.b("};"),r.b("\n"+n),r.b("struct Material {"),r.b("\n"+n),r.b("	// zwei Boolesche Variablen zur Auswahl der BRDF"),r.b("\n"+n),r.b("	bool isPerfectMirror;"),r.b("\n"+n),r.b("	bool isDiffuse;"),r.b("\n"+n),r.b("	vec3 Le; // L_emit"),r.b("\n"+n),r.b("	vec3 Kd; // Farbe "),r.b("\n"+n),r.b("};"),r.b("\n"+n),r.b("struct Hit {"),r.b("\n"+n),r.b("	// eigentlich sind t und hitPoint redundant, aber t ist eine schnelle Metrik für die Abstandsmessung und hitPoint"),r.b("\n"+n),r.b("	// ist hier einfach gut aufgehoben"),r.b("\n"+n),r.b("	float t;"),r.b("\n"+n),r.b("	vec3 hitPoint;"),r.b("\n"+n),r.b("	Material material;"),r.b("\n"+n),r.b("	vec3 normal;"),r.b("\n"+n),r.b("};"),r.b("\n"),r.b("\n"+n),r.b("// uniforms"),r.b("\n"+n),r.b("uniform vec3 La; // Hintergrundfarbe"),r.b("\n"),r.b("\n"+n),r.b("// Benötigt für Zufallsvariable"),r.b("\n"+n),r.b("uniform float secondsSinceStart;"),r.b("\n"),r.b("\n"+n),r.b("uniform sampler2D texture0;"),r.b("\n"+n),r.b("uniform float textureWeight;"),r.b("\n"+n),r.b("uniform vec3 eyePosition;"),r.b("\n"),r.b("\n"+n),r.b("// varyings"),r.b("\n"+n),r.b("varying vec3 rayDirection;"),r.b("\n"+n),r.b("varying vec2 texCoords;"),r.b("\n"),r.b("\n"+n),r.b("//"),r.s(r.f("hasSpheres",t,e,1),t,e,0,1252,2582,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b("struct Sphere {"),r.b("\n"+n),r.b("	vec3 center;"),r.b("\n"+n),r.b("	float radius;"),r.b("\n"+n),r.b("};"),r.b("\n"),r.b("\n"+n),r.b("uniform Sphere spheres[NUMBER_OF_SPHERES];"),r.b("\n"+n),r.b("uniform Material sphereMaterials[NUMBER_OF_SPHERES];"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(' * Schneidet ray mit sphere und liefert inout-firstHit, falls "out"-firstHit.t in (tMin, ..., "in"-firstHit.t) liegt.'),r.b("\n"+n),r.b(" * Sonst: nichts. material gehört zu sphere."),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("void hitSphere(Ray ray, Sphere sphere, float tMin, inout Hit firstHit, Material material) {"),r.b("\n"+n),r.b("	vec3 toSphere = ray.start - sphere.center;"),r.b("\n"),r.b("\n"+n),r.b("	// Terme der Mitternachtsformel"),r.b("\n"+n),r.b("	float a = dot(ray.direction, ray.direction);"),r.b("\n"+n),r.b("	float b = 2.0 * dot(toSphere, ray.direction);"),r.b("\n"+n),r.b("	float c = dot(toSphere, toSphere) - sphere.radius * sphere.radius;"),r.b("\n"+n),r.b("	float discriminant = b * b - 4.0 * a * c; // Wurzel"),r.b("\n"),r.b("\n"+n),r.b("	if (discriminant < 0.0) return; // keine Lösung"),r.b("\n"),r.b("\n"+n),r.b("	if (discriminant == 0.0) { // eine Lösung"),r.b("\n"+n),r.b("		float t = -b / (2.0 * a);"),r.b("\n"),r.b("\n"+n),r.b("		if (tMin < t && t < firstHit.t) {"),r.b("\n"+n),r.b("			vec3 hitPoint = ray.start + t * ray.direction;"),r.b("\n"+n),r.b("			firstHit = Hit(t, hitPoint, material, normalize(hitPoint - sphere.center));"),r.b("\n"+n),r.b("		}"),r.b("\n"+n),r.b("	} else { // zwei Lösungen"),r.b("\n"+n),r.b("		float t0 = (-b + sqrt(discriminant)) / (2.0 * a);"),r.b("\n"+n),r.b("		float t1 = (-b - sqrt(discriminant)) / (2.0 * a);"),r.b("\n"+n),r.b("		float t = min(t0, t1);"),r.b("\n"),r.b("\n"+n),r.b("		if (tMin < t && t < firstHit.t) {"),r.b("\n"+n),r.b("			vec3 hitPoint = ray.start + t * ray.direction;"),r.b("\n"+n),r.b("			firstHit = Hit(t, hitPoint, material, normalize(hitPoint - sphere.center));			"),r.b("\n"+n),r.b("		}"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("}"),r.b("\n"+n),r.b("//")}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("//"),r.s(r.f("hasCornellBox",t,e,1),t,e,0,2619,3490,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b("struct Plane { // Hessesche Normalform"),r.b("\n"+n),r.b("	vec3 n;"),r.b("\n"+n),r.b("	float d;"),r.b("\n"+n),r.b("};"),r.b("\n"),r.b("\n"+n),r.b("struct CornellBox {"),r.b("\n"+n),r.b("	Plane planes[6];"),r.b("\n"+n),r.b("	Material materials[6];"),r.b("\n"+n),r.b("	// eigentlich redundant, aber benötigt für Mittelpunktberechnung (siehe Li-Berechnung)"),r.b("\n"+n),r.b("	vec3 minCorner;"),r.b("\n"+n),r.b("	vec3 maxCorner;"),r.b("\n"+n),r.b("};"),r.b("\n"),r.b("\n"+n),r.b("uniform CornellBox cornellBox;"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(' * Schneidet ray mit plane und liefert inout-firstHit, falls "out"-firstHit.t in (tMin, ..., "in"-firstHit.t) liegt.'),r.b("\n"+n),r.b(" * Sonst: nichts. material gehört zu plane."),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("void hitPlane(Ray ray, Plane plane, float tMin, inout Hit firstHit, Material material) {"),r.b("\n"+n),r.b("	float denominator = dot(plane.n, ray.direction); // z. dt. Nenner"),r.b("\n"),r.b("\n"+n),r.b("	if (denominator == 0.0) return;"),r.b("\n"),r.b("\n"+n),r.b("	float t = (plane.d - dot(plane.n, ray.start)) / denominator;"),r.b("\n"),r.b("\n"+n),r.b("	if (tMin < t && t < firstHit.t) {"),r.b("\n"+n),r.b("		vec3 hitPoint = ray.start + t * ray.direction;"),r.b("\n"+n),r.b("		firstHit = Hit(t, hitPoint, material, plane.n); // bereits Normalisiert"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("}"),r.b("\n"+n),r.b("//")
}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("//"),r.s(r.f("hasMesh",t,e,1),t,e,0,3524,5521,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b("struct Triangle {"),r.b("\n"+n),r.b("	vec3 v0;"),r.b("\n"+n),r.b("	vec3 v1;"),r.b("\n"+n),r.b("	vec3 v2;"),r.b("\n"+n),r.b("	vec3 n; // erst mal reicht nur eine Normale"),r.b("\n"+n),r.b("};"),r.b("\n"),r.b("\n"+n),r.b("struct Mesh {"),r.b("\n"+n),r.b("	sampler2D data;"),r.b("\n"+n),r.b("	vec2 onePixel; // Größe eines Pixel zur Adressierung"),r.b("\n"+n),r.b("};"),r.b("\n"),r.b("\n"+n),r.b("uniform Mesh mesh;"),r.b("\n"+n),r.b("uniform Material meshMaterial;"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(' * Schneidet ray mit triangle und liefert inout-firstHit, falls "out"-firstHit.t in (tMin, ..., "in"-firstHit.t)'),r.b("\n"+n),r.b(" * liegt. Sonst: nichts. material gehört zu triangle."),r.b("\n"+n),r.b(" * @author vgl. Moeller, S. 581"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("void hitTriangle(Ray ray, Triangle triangle, float tMin, inout Hit firstHit, Material material) {"),r.b("\n"+n),r.b("	vec3 e1 = triangle.v1 - triangle.v0;"),r.b("\n"+n),r.b("	vec3 e2 = triangle.v2 - triangle.v0;"),r.b("\n"+n),r.b("	vec3 p = cross(ray.direction, e2);"),r.b("\n"+n),r.b("	float a = dot(e1, p);"),r.b("\n"+n),r.b('	if (a > -EPSILON && a < EPSILON) return; // "REJECT"'),r.b("\n"+n),r.b("	float f = 1.0 / a;"),r.b("\n"+n),r.b("	vec3 s = ray.start - triangle.v0;"),r.b("\n"+n),r.b("	float u = f * dot(s, p);"),r.b("\n"+n),r.b('	if (u < 0.0 || u > 1.0) return; // "REJECT"'),r.b("\n"+n),r.b("	vec3 q = cross(s, e1);"),r.b("\n"+n),r.b("	float v = f * dot(ray.direction, q);"),r.b("\n"+n),r.b('	if (v < 0.0 || (u + v) > 1.0) return; // "REJECT"'),r.b("\n"+n),r.b("	float t = f * dot(e2, q);"),r.b("\n"),r.b("\n"+n),r.b("	if (tMin < t && t < firstHit.t) {"),r.b("\n"+n),r.b("		vec3 hitPoint = ray.start + t * ray.direction;"),r.b("\n"+n),r.b("		firstHit = Hit(t, hitPoint, material, triangle.n); // bereits Normalisiert"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(' * Liefert den RGB-Vektor von Pixel [x, y] der mesh.data Textur. Der Wertebereich pro Kanal "ist Element von"'),r.b("\n"+n),r.b(" * [-128.0, ..., 127.0], also der eines Bytes in Zweierkomplement-Darstellung. Es handelt sich tatsächlich um nur 255"),r.b("\n"+n),r.b(' * Werte, obwohl es "floats" sind. Das Weiterrechnen mit floats ist einfach einfacher. Mit r lassen sich die Werte'),r.b("\n"+n),r.b(" * konstant erhöhen oder verringern. Das ist eine Trick, um die Richtung --- auf- oder abrunden --- bei einem Cast auf "),r.b("\n"+n),r.b(" * int einzustellen. ceil() oder floor() müssen dann nicht noch extra angewendet werden."),r.b("\n"+n),r.b(" * "),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("vec3 meshSamplerLookup(int x, int y, float r) {"),r.b("\n"+n),r.b("	vec3 res = texture2D(mesh.data, vec2(x, y) * mesh.onePixel).xyz * 255.0 + r;"),r.b("\n"),r.b("\n"+n),r.b("	// Zweierkomplement"),r.b("\n"+n),r.b("	bvec3 b = greaterThan(res, vec3(127.0, 127.0, 127.0));"),r.b("\n"+n),r.b("	res -= vec3(256.0, 256.0, 256.0) * vec3(b);"),r.b("\n"),r.b("\n"+n),r.b("	return res;"),r.b("\n"+n),r.b("}"),r.b("\n"+n),r.b("//")}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * Schneidet alle Szeneobjekte mit ray und liefert den nächstliegendsten Hit."),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("Hit sceneFirstHit(Ray ray) {"),r.b("\n"+n),r.b('	Hit firstHit; firstHit.t = T_MAX; // firstHit repräsentiert zunächst den "Schnitt in der Unendlichkeit"'),r.b("\n"),r.b("\n"+n),r.b("	// Li-Berechnung benötigt Le!"),r.b("\n"+n),r.b("	Material firstHitMaterial;"),r.b("\n"+n),r.b("	firstHitMaterial.Le = vec3(0.0, 0.0, 0.0);"),r.b("\n"+n),r.b("	firstHit.material = firstHitMaterial;"),r.b("\n"),r.b("\n"+n),r.b("	//"),r.s(r.f("hasSpheres",t,e,1),t,e,0,5917,6038,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b("	for (int i = 0; i < NUMBER_OF_SPHERES; i++) {"),r.b("\n"+n),r.b("		hitSphere(ray, spheres[i], T_MIN, firstHit, sphereMaterials[i]);"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("	//")}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("	//"),r.s(r.f("hasCornellBox",t,e,1),t,e,0,6076,6214,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b('	for (int i = 0; i < 6; i++) { // immer 6 "Wände"'),r.b("\n"+n),r.b("		hitPlane(ray, cornellBox.planes[i], T_MIN, firstHit, cornellBox.materials[i]);"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("	//")}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("	//"),r.s(r.f("hasMesh",t,e,1),t,e,0,6249,6820,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b("	for (int i = 0; i < MESH_SAMPLER_WIDTH; i++) {"),r.b("\n"+n),r.b("		ivec3 indices = ivec3(meshSamplerLookup(i, 3, 0.1)); // Der Textur-Ursprung ist links-unten"),r.b("\n"),r.b("\n"+n),r.b('		// "0-terminierend"'),r.b("\n"+n),r.b("		if (indices.x == 0 && indices.y == 0 && indices.z == 0) break;"),r.b("\n"),r.b("\n"+n),r.b("		Triangle triangle = Triangle(meshSamplerLookup(indices.x, 2, 0.0),"),r.b("\n"+n),r.b("			                         meshSamplerLookup(indices.y, 2, 0.0),"),r.b("\n"+n),r.b("			                         meshSamplerLookup(indices.z, 2, 0.0),"),r.b("\n"+n),r.b("			                         normalize(meshSamplerLookup(i, 1, 0.0)));"),r.b("\n"),r.b("\n"+n),r.b("		hitTriangle(ray, triangle, T_MIN, firstHit, meshMaterial);"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("	//")}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("	return firstHit;"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * Berechnet die lokale Beleuchtung in x durch die Lichtquelle in Richtung s mit n ist die Normale in x. Das Resultat"),r.b("\n"+n),r.b(" * der Berechnung wird zu res addiert."),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("void Li(vec3 x, vec3 s, vec3 n, inout vec3 res) {"),r.b("\n"+n),r.b("	Hit hit = sceneFirstHit(Ray(x, s));"),r.b("\n"+n),r.b("	float theCos = dot(n, s);"),r.b("\n"+n),r.b("	if (theCos > 0.0) res += hit.material.Le * theCos; // Trick: Schatten-Test ohne if"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * Berechnet die lokale Beleuchtung in hit durch alle Lichtquellen der Szene."),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("vec3 prepareLiCalculation(Hit hit) {"),r.b("\n"+n),r.b("	vec3 res = vec3(0.0, 0.0, 0.0);"),r.b("\n"),r.b("\n"+n),r.b("	//"),r.s(r.f("hasSpheres",t,e,1),t,e,0,7396,7642,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b("	for (int i = 0; i < NUMBER_OF_SPHERICAL_LIGHTS; i++) {"),r.b("\n"+n),r.b("		// die Lichter befinden sich am Anfang der Reihungen"),r.b("\n"+n),r.b("		vec3 toSource = normalize(spheres[i].center - hit.hitPoint); // TODO Sampling!"),r.b("\n"+n),r.b("		Li(hit.hitPoint, toSource, hit.normal, res);"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b("	//")}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("	//"),r.s(r.f("hasCornellBox",t,e,1),t,e,0,7680,8065,"{{ }}")&&(r.rs(t,e,function(t,e,r){r.b("\n"+n),r.b("	vec2 centerXY = vec2((cornellBox.minCorner.x + cornellBox.maxCorner.x) / 2.0,"),r.b("\n"+n),r.b("				   (cornellBox.minCorner.y + cornellBox.maxCorner.y) / 2.0); // TODO Sampling"),r.b("\n"),r.b("\n"+n),r.b('	// TODO noch "hard coded"! Und zwar leuchtet die "top plane"'),r.b("\n"+n),r.b("	vec3 toCornellBoxNearSource = normalize(vec3(centerXY, cornellBox.maxCorner.z) - hit.hitPoint);"),r.b("\n"+n),r.b("	Li(hit.hitPoint, toCornellBoxNearSource, hit.normal, res);"),r.b("\n"+n),r.b("	//")}),t.pop()),r.b("\n"),r.b("\n"+n),r.b("	return res;"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * konstant"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("vec3 perfectMirrorBRDF() {"),r.b("\n"+n),r.b("	return vec3(1.0, 1.0, 1.0);"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(' * Liefert den "perfekten" Ausfallvektor out-L. Achtung: i ist der "incident vector" --> Richtung beachten! n ist die '),r.b("\n"+n),r.b(" * Normale."),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("float perfectMirrorNextDirection(out vec3 L, vec3 i, vec3 n) {"),r.b("\n"+n),r.b("	L = normalize(reflect(i, n)); // TODO already normalized?"),r.b("\n"+n),r.b("	return 1.0;"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * konstant"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("vec3 diffuseBRDF(Material material) {"),r.b("\n"+n),r.b("	return material.Kd;"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * Liefert, je nach scale und seed, ein Zufallszahl."),r.b("\n"+n),r.b(" * @author vgl. Evan Wallace"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("float random(vec3 scale, float seed) {"),r.b("\n"+n),r.b("	return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(' * Liefert den zufälligen Ausfallvektor out-L aus der Halbkugel und seine Wahrscheinlichkeit als "return value". N ist'),r.b("\n"+n),r.b(' * die Normale und V ist der "view"-Vektor. Achtung: V "zeigt" entgegengesetzt zur Strahl-Richtung! seed wird für die'),r.b("\n"+n),r.b(" * Zufallszahl-Berechnung benötigt."),r.b("\n"+n),r.b(" * @author vgl. Szirmay-Kalos, S. 104"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("float diffuseNextDirection(out vec3 L, vec3 N, vec3 V, float seed) {"),r.b("\n"+n),r.b("	float u = random(vec3(12.9898, 78.233, 151.7182), seed);"),r.b("\n"+n),r.b("	float v = random(vec3(63.7264, 10.873, 623.6736), seed);"),r.b("\n"),r.b("\n"+n),r.b("	float theta = asin(sqrt(u));"),r.b("\n"+n),r.b("	float phi = M_PI * 2.0 * v;"),r.b("\n"+n),r.b("	vec3 O = cross(N, vec3(0, 0, 1));"),r.b("\n"),r.b("\n"+n),r.b("	if (length(O) < EPSILON) {"),r.b("\n"+n),r.b("		O = cross(N, vec3(0, 1, 0));"),r.b("\n"+n),r.b("	}"),r.b("\n"),r.b("\n"+n),r.b("	vec3 P = cross(N, O);"),r.b("\n"),r.b("\n"+n),r.b("	L = normalize(N * cos(theta) + O * sin(theta) * cos(phi) + P * sin(theta) * sin(phi)); // TODO already normalized?"),r.b("\n"),r.b("\n"+n),r.b("	float prob = cos(theta) / M_PI;"),r.b("\n"+n),r.b("	return prob;"),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("/**"),r.b("\n"+n),r.b(" * Path tracing (vgl. Szirmay-Kalos, S. 112; Kevin Suffern S. 547 - 549)"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b("vec3 pathTrace() {"),r.b("\n"+n),r.b("	Ray ray = Ray(eyePosition, normalize(rayDirection)); // Primärstrahl"),r.b("\n"+n),r.b("	vec3 resColor = vec3(1, 1, 1);"),r.b("\n"),r.b("\n"+n),r.b("	for (int j = 0; j < DEPTH; j++) { // entspricht dem Produkt von i = 0 bis n"),r.b("\n"+n),r.b("		Hit hit = sceneFirstHit(ray);"),r.b("\n"),r.b("\n"+n),r.b("		// Fall: kein Schnittpunkt"),r.b("\n"+n),r.b("		if (hit.t == T_MAX) return La;"),r.b("\n"),r.b("\n"+n),r.b("		// Fall: Licht geschnitten"),r.b("\n"+n),r.b("		if (length(hit.material.Le) > 0.0) {"),r.b("\n"+n),r.b("			return resColor * hit.material.Le;"),r.b("\n"+n),r.b("		}"),r.b("\n"),r.b("\n"+n),r.b("		// L_i (leider zu langsam)"),r.b("\n"+n),r.b("		// resColor += prepareLiCalculation(hit);"),r.b("\n"),r.b("\n"+n),r.b("		// BRDF und Co."),r.b("\n"+n),r.b("		vec3 brdf; vec3 nextDirection;"),r.b("\n"+n),r.b("		float prob;"),r.b("\n"),r.b("\n"+n),r.b("		if (hit.material.isPerfectMirror) {"),r.b("\n"+n),r.b("			brdf = perfectMirrorBRDF();"),r.b("\n"+n),r.b("			prob = perfectMirrorNextDirection(nextDirection, ray.direction, hit.normal);"),r.b("\n"+n),r.b("		} else if (hit.material.isDiffuse) {"),r.b("\n"+n),r.b("			brdf = diffuseBRDF(hit.material);"),r.b("\n"+n),r.b("			prob = diffuseNextDirection(nextDirection, hit.normal, -ray.direction, secondsSinceStart + float(j));"),r.b("\n"+n),r.b("		}"),r.b("\n"),r.b("\n"+n),r.b("		if (prob < EPSILON) return La; // Russian Roulette"),r.b("\n"),r.b("\n"+n),r.b("		float cost = dot(nextDirection, hit.normal);"),r.b("\n"+n),r.b("		if (cost < 0.0) cost = -cost;"),r.b("\n"+n),r.b("		if (cost < EPSILON) return La;"),r.b("\n"),r.b("\n"+n),r.b("		// resColor akkumulieren"),r.b("\n"+n),r.b("		resColor *= brdf * cost / prob;"),r.b("\n"),r.b("\n"+n),r.b("		// Iteration"),r.b("\n"+n),r.b("		ray = Ray(hit.hitPoint, nextDirection); // neuer Strahl"),r.b("\n"+n),r.b("	}"),r.b("\n"+n),r.b('	return La; // Fall: maximale "depth" erreicht'),r.b("\n"+n),r.b("}"),r.b("\n"),r.b("\n"+n),r.b("void main() {"),r.b("\n"+n),r.b('	// "blending" vgl. Evan Wallace'),r.b("\n"+n),r.b("	gl_FragColor = mix(vec4(pathTrace(), 1.0), texture2D(texture0, texCoords), textureWeight);"),r.b("\n"+n),r.b("}"),r.b("\n"),r.fl()},partials:{},subs:{}},"",t);return e.template=n,e}),n("hgn!../shaders/texture.vert",["hogan"],function(t){function e(){return n.render.apply(n,arguments)}var n=new t.Template({code:function(t,e,n){var r=this;return r.b(n=n||""),r.b("/*"),r.b("\n"+n),r.b(" * WebGL core teaching framwork "),r.b("\n"+n),r.b(" * (C)opyright Hartmut Schirmacher, hschirmacher.beuth-hochschule.de"),r.b("\n"+n),r.b(" * (C)opyright Niels Garve, niels.garve.yahoo.de"),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" * Vertex Shader: texture"),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" * This shader expects a 3D vertex position plus a 2D texture coordinate"),r.b("\n"+n),r.b(" * vertexTexCoords per vertex, and passes the texture coordinate through"),r.b("\n"+n),r.b(" * to the fragment shader using the varying texCoords."),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b(" "),r.b("\n"+n),r.b("#version 100"),r.b("\n"+n),r.b("precision mediump float;"),r.b("\n"),r.b("\n"+n),r.b("attribute vec3 vertexPosition;"),r.b("\n"+n),r.b("attribute vec2 vertexTexCoords;"),r.b("\n"),r.b("\n"+n),r.b("// uniform mat4 modelViewMatrix;"),r.b("\n"+n),r.b("uniform mat4 projectionMatrix;"),r.b("\n"),r.b("\n"+n),r.b("varying vec2 texCoords;"),r.b("\n"),r.b("\n"+n),r.b("void main() {"),r.b("\n"+n),r.b("	gl_Position = projectionMatrix *"),r.b("\n"+n),r.b("				  // modelViewMatrix *"),r.b("\n"+n),r.b("				  vec4(vertexPosition, 1.0);"),r.b("\n"),r.b("\n"+n),r.b("	texCoords = vertexTexCoords;"),r.b("\n"+n),r.b("}"),r.b("\n"),r.fl()},partials:{},subs:{}},"",t);return e.template=n,e}),n("hgn!../shaders/texture.frag",["hogan"],function(t){function e(){return n.render.apply(n,arguments)}var n=new t.Template({code:function(t,e,n){var r=this;return r.b(n=n||""),r.b("/*"),r.b("\n"+n),r.b(" * WebGL core teaching framwork "),r.b("\n"+n),r.b(" * (C)opyright Hartmut Schirmacher, hschirmacher.beuth-hochschule.de "),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" * Fragment Shader: texture"),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" * This module expects a 2D texture in texture0 and 2D texture coordinates"),r.b("\n"+n),r.b(" * in varying texCoords, and uses the texture value as fragment color."),r.b("\n"+n),r.b(" *"),r.b("\n"+n),r.b(" */"),r.b("\n"+n),r.b(" "),r.b("\n"+n),r.b("#version 100"),r.b("\n"+n),r.b("precision mediump float;"),r.b("\n"),r.b("\n"+n),r.b("uniform sampler2D texture0;"),r.b("\n"),r.b("\n"+n),r.b("varying vec2 texCoords;"),r.b("\n"),r.b("\n"+n),r.b("void main() {"),r.b("\n"+n),r.b("	gl_FragColor = texture2D(texture0, texCoords);"),r.b("\n"+n),r.b("}"),r.b("\n"),r.fl()},partials:{},subs:{}},"",t);return e.template=n,e}),n("scene",["gl-matrix","program","scene_node","texture","light","material","stage","mesh","Config","hgn!../shaders/pathtracing.vert","hgn!../shaders/pathtracing.frag","hgn!../shaders/texture.vert","hgn!../shaders/texture.frag"],function(t,e,n,r,i,a,o,s,u,c,b,l,f){"use strict";function h(t){t.setUniform("La","vec3",[.133,.133,.133]),t.setUniform("spheres[0].center","vec3",[-20,60,-30]),t.setUniform("spheres[0].radius","float",7.5),t.setUniform("sphereMaterials[0].isPerfectMirror","bool",!1),t.setUniform("sphereMaterials[0].isDiffuse","bool",!1),t.setUniform("sphereMaterials[0].Le","vec3",[1,1,1]),t.setUniform("sphereMaterials[0].Kd","vec3",[1,1,1]),t.setUniform("spheres[1].center","vec3",[0,85,85]),t.setUniform("spheres[1].radius","float",35),t.setUniform("sphereMaterials[1].isPerfectMirror","bool",!1),t.setUniform("sphereMaterials[1].isDiffuse","bool",!1),t.setUniform("sphereMaterials[1].Le","vec3",[.66,.66,.66]),t.setUniform("sphereMaterials[1].Kd","vec3",[1,1,1]),t.setUniform("meshMaterial.isPerfectMirror","bool",!1),t.setUniform("meshMaterial.isDiffuse","bool",!0),t.setUniform("meshMaterial.Le","vec3",[0,0,0]),t.setUniform("meshMaterial.Kd","vec3",[1,1,1])}function d(t,e,n){if(!t.indices||!t.vertices||!t.vertexNormals)throw new Error("bad parameter: mesh");if(t.indices.length>3*e||t.vertices.length>3*e||t.vertexNormals.length>3*e||3>n)throw new Error("mesh doesn't fit the sampler");var r,i,a,o=new Uint8Array(e*n*3);for(r=0;r<t.indices.length;r++)o[r]=t.indices[r];for(i=0;i<t.vertices.length;i++)o[3*e+i]=t.vertices[i];for(a=0;a<t.vertexNormals.length;a++)o[6*e+a]=127*t.vertexNormals[a];return o}var m=function(i){this.gl=i;var a=new u,m=a.get("MESH_SAMPLER_WIDTH"),p=a.get("MESH_SAMPLER_HEIGHT"),v=i.canvas,g=new s(document.getElementById("mesh").innerHTML),M=d(g,m,p);this.framebuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this.framebuffer),this.framebuffer.width=v.width,this.framebuffer.height=v.height;var x=new r.Texture2D(i).init_2(this.framebuffer.width,this.framebuffer.height,null),y=new r.Texture2D(i).init_2(m,p,M);x.setTexParameter(i.TEXTURE_MAG_FILTER,i.NEAREST),x.setTexParameter(i.TEXTURE_MIN_FILTER,i.NEAREST),y.setTexParameter(i.TEXTURE_MAG_FILTER,i.NEAREST),y.setTexParameter(i.TEXTURE_MIN_FILTER,i.NEAREST),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,x.glTextureObject(),0),i.bindFramebuffer(i.FRAMEBUFFER,null),this.camera={},this.camera.viewMatrix=t.mat4.lookAt(t.mat4.create(),[0,0,0],[-.2,1,-.6],[0,0,1]),this.camera.projectionMatrix=t.mat4.ortho(t.mat4.create(),-1,1,-1,1,.01,100),this.prog_pathtracing=new e(i,c({}),b({hasSpheres:!0,numberOfSpheres:2,numberOfSphericalLights:2,hasCornellBox:!1,hasMesh:!0,meshSamplerWidth:a.get("MESH_SAMPLER_WIDTH")})),this.prog_texture=new e(i,l({}),f({})),this.prog_texture.use(),this.prog_texture.setUniform("projectionMatrix","mat4",this.camera.projectionMatrix),this.prog_texture.setTexture("texture0",0,x),this.prog_pathtracing.use(),this.prog_pathtracing.setUniform("projectionMatrix","mat4",this.camera.projectionMatrix),this.prog_pathtracing.setTexture("texture0",0,x),this.prog_pathtracing.setTexture("mesh.data",1,y),this.prog_pathtracing.setUniform("mesh.onePixel","vec2",[1/m,1/p]),this.prog_pathtracing.setUniform("eyePosition","vec3",[0,0,0]),h(this.prog_pathtracing),this.stage=new o(i),this.stageNode=new n("StageNode",[this.stage],null),this.world=new n("world",[this.stageNode],null),this.sampleCounter=0};return m.prototype.draw=function(t){var e=this.gl;this.prog_pathtracing.use(),this.prog_pathtracing.setUniform("secondsSinceStart","float",.001*t),this.prog_pathtracing.setUniform("textureWeight","float",this.sampleCounter/(this.sampleCounter+1));var n=this.camera.viewMatrix;e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.clearColor(1,1,1,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),this.world.draw(e,this.prog_pathtracing,n),e.bindFramebuffer(e.FRAMEBUFFER,null),this.world.draw(e,this.prog_texture,n),this.sampleCounter++},m}),n("animation",[],function(){"use strict";window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)}}(),window.cancelRequestAnimFrame=function(){return window.cancelCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.clearTimeout}();var t=function(t,e){this.updateFunction=t,this.firstTime=0,this.lastTime=0,this.waitingTime=0,e?this.start():this.stop()};return t.prototype.isRunning=function(){return!this.isStopped},t.prototype.start=function(){this.firstTime=0,this.lastTime=0,this.waitingTime=0,this.isStopped=!1,this.update()},t.prototype.stop=function(){this.isStopped=!0},t.prototype.resume=function(){if(0==this.lastTime)this.firstTime=(new Date).getTime(),this.lastTime=(new Date).getTime();else{var t=(new Date).getTime()-this.lastTime;this.waitingTime+=t,this.lastTime+=t}this.isStopped=!1,this.update()},t.prototype.toggleAnimation=function(){this.isRunning()?this.stop():this.resume()},t.prototype.update=function(){if(this.isRunning()){var t=(new Date).getTime(),e=t-this.firstTime-this.waitingTime,n=t-this.lastTime;this.lastTime=t;var r=this;requestAnimFrame(function(){r.update()}),this.updateFunction(e,n)}},t}),n("scene_explorer",["gl-matrix"],function(t){"use strict";var e=function(t,e,n,r){this.canvas=t,this.triggerRedraw=e,this.scene=n,this.scene2=r,this.camera=n.camera,this.dragMode="rotation",this.draggingStarted=!1,this.startX=0,this.startY=0,this.KEY_NONE=0,this.KEY_SHIFT=1,this.KEY_ALT=2,this.KEY_CTRL=4,this.KEY_META=8,this.KEY_ALL=15,this.activeModifierKeys=this.KEY_NONE,this.rotSensitivity=.01,this.zoomSensitivity=.01,this.transSensitivity=.01,this.attachToCanvas(this.canvas)};return e.prototype.startDragging=function(t,e,n){this.startX=t,this.startY=e,n&&(this.dragMode=n),this.draggingStarted=!0},e.prototype.stopDragging=function(t,e){var n=this.continueDragging(t,e);return this.draggingStarted=!1,n},e.prototype.continueDragging=function(e,n){if(void 0==e||void 0==n)return!1;if(!this.draggingStarted)return!1;var r=e-this.startX,i=n-this.startY;if(this.startX=e,this.startY=n,Math.abs(r)<2&&Math.abs(i)<2)return!1;if("rotate"==this.dragMode){var a=r*this.rotSensitivity,o=i*this.rotSensitivity,s=t.vec3.fromValues(1,0,0),u=t.vec3.fromValues(0,1,0),c=t.mat4.invert(t.mat4.create(),this.camera.viewMatrix);c[12]=0,c[13]=0,c[14]=0;var b=t.mat4.create(),l=t.mat4.create();t.vec3.transformMat4(s,s,c),t.vec3.transformMat4(u,u,c),t.mat4.rotate(b,b,o,s),t.mat4.rotate(l,l,a,u),t.mat4.multiply(this.scene.world.transformation,b,this.scene.world.transformation),t.mat4.multiply(this.scene.world.transformation,l,this.scene.world.transformation)}else if("translateXY"==this.dragMode){var f=vec3.create([r*this.transSensitivity,-i*this.transSensitivity,0]);mat4.translate(this.scene.camera.viewMatrix,f)}else if("translateZ"==this.dragMode){var f=vec3.create([0,0,-i*this.zoomSensitivity]);mat4.translate(this.scene.camera.viewMatrix,f)}return void 0!=this.scene2&&(this.scene2.world.transformation=mat4.create(this.scene.world.transformation),this.scene2.camera.viewMatrix=mat4.create(this.scene.camera.viewMatrix)),!0},e.prototype.redraw=function(){this.scene.sampleCounter=0,this.triggerRedraw&&(this.scene.draw(),void 0!=this.scene2&&this.scene2.draw())},e.prototype.attachToCanvas=function(t){var e=this;t.mouseDown=function(t){var n=e,r="unknown";t.which?(3==t.which&&(r="right"),2==t.which&&(r="middle"),1==t.which&&(r="left")):(4&t.button&&(r="middle"),2&t.button&&(r="right"),1&t.button&&(r="left")),"left"==r?n.activeModifierKeys==n.KEY_NONE?n.startDragging(t.clientX,t.clientY,"rotate"):n.activeModifierKeys==n.KEY_SHIFT?n.startDragging(t.clientX,t.clientY,"translateXY"):n.activeModifierKeys==n.KEY_ALT&&n.startDragging(t.clientX,t.clientY,"translateZ"):"right"==r?n.startDragging(t.clientX,t.clientY,"translateXY"):"middle"==r?n.startDragging(t.clientX,t.clientY,"translateZ"):log("could not recognize mouse button!")},t.mouseUp=function(t){var n=e;n.stopDragging(t.clientX,t.clientY)&&n.redraw()},t.mouseMove=function(t){var n=e;n.continueDragging(t.clientX,t.clientY)&&n.redraw()},t.keyDown=function(t){var n=e;n.draggingStarted&&n.stopDragging(t.clientX,t.clientY)&&n.redraw(),n.activeModifierKeys=n.KEY_NONE,t.shiftKey&&(n.activeModifierKeys+=n.KEY_SHIFT),t.ctrlKey&&(n.activeModifierKeys+=n.KEY_CTRL),t.altKey&&(n.activeModifierKeys+=n.KEY_ALT),t.metaKey&&(n.activeModifierKeys+=n.KEY_META)},t.keyUp=function(t){var n=e;n.draggingStarted&&n.stopDragging(t.clientX,t.clientY)&&n.redraw(),n.activeModifierKeys=n.KEY_NONE,t.shiftKey&&(n.activeModifierKeys+=n.KEY_SHIFT),t.ctrlKey&&(n.activeModifierKeys+=n.KEY_CTRL),t.altKey&&(n.activeModifierKeys+=n.KEY_ALT),t.metaKey&&(n.activeModifierKeys+=n.KEY_META)},t.onmousedown=t.mouseDown,t.onmouseup=t.mouseUp,t.onmousemove=t.mouseMove,window.document.onkeydown=t.keyDown,window.document.onkeyup=t.keyUp},e}),n("main",["gl-matrix","scene","animation","scene_explorer"],function(t,e,n,r){"use strict";t.glMatrix.setMatrixArrayType(Float32Array);var i=function(t){this.scene=new e(t),this.animation=new n(function(t){this.scene.draw(t)}.bind(this)),new r(t.canvas,!1,this.scene)};return i.prototype.drawFirstFrame=function(){this.scene.draw(0)},i.prototype.start=function(){this.scene.sampleCounter=0,this.animation.start()},i.prototype.stop=function(){this.animation.stop()},i.prototype.resume=function(){this.animation.resume()},i}),e("main")});
//# sourceMappingURL=raymond.js
//# sourceMappingURL=raymond.js.map